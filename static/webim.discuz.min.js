(function(y,v,ba){function qa(){return(new Date).getTime()}function W(d){return ra.call(d)==="[object Function]"}function Y(d){return ra.call(d)==="[object Array]"}function ea(d){return d&&ra.call(d)==="[object Object]"}function ia(d){return(d||"").replace(/^\s+|\s+$/g,"")}function X(d,f){var h=false;if(ea(f)){d=d||{};for(var j in f){var k=f[j];if(d[j]!=k){h=h||{};h[j]=k}}}return h}function E(d){var f=[];if(d!=null){var h=d.length;if(h==null||typeof d==="string"||W(d)||d.setInterval)f[0]=d;else for(;h;)f[--h]=
d[h]}return f}function w(){var d=arguments[0]||{},f=1,h=arguments.length,j=false,k;if(typeof d==="boolean"){j=d;d=arguments[1]||{};f=2}if(typeof d!=="object"&&!W(d))d={};for(;f<h;f++)if((k=arguments[f])!=null)for(var n in k){var o=d[n],t=k[n];if(d!==t)if(j&&t&&typeof t==="object"&&!t.nodeType)d[n]=w(j,o||(t.length!=null?[]:{}),t);else if(t!==ba)d[n]=t}return d}function M(d,f,h){var j,k=0,n=d.length,o=n===ba||W(d);if(h)if(o)for(j in d){if(f.apply(d[j],h)===false)break}else for(;k<n;){if(f.apply(d[k++],
h)===false)break}else if(o)for(j in d){if(f.call(d[j],j,d[j])===false)break}else for(h=d[0];k<n&&f.call(h,k,h)!==false;h=d[++k]);return d}function ja(d,f){for(var h=[],j,k=0,n=d.length;k<n;k++){j=f(d[k],k);if(j!=null)h[h.length]=j}return h.concat.apply([],h)}function la(d){var f=[];if(typeof d=="object"){for(var h in d)f[f.length]=encodeURIComponent(h)+"="+encodeURIComponent(d[h]);return f.join("&").replace(F,"+")}return d}function D(d){d=w(true,d,w(true,{},I,d));var f,h,j=d.context||y,k=d.type.toUpperCase();
if(d.data&&d.processData&&typeof d.data!=="string")d.data=la(d.data);if(d.cache===false&&k==="GET"){var n=qa(),o=d.url.replace(sa,"$1_="+n+"$2");d.url=o+(o===d.url?(z.test(d.url)?"&":"?")+"_="+n:"")}if(d.data&&k==="GET")d.url+=(z.test(d.url)?"&":"?")+d.data;var t=false,r=d.xhr();d.username?r.open(k,d.url,d.async,d.username,d.password):r.open(k,d.url,d.async);try{d.data&&r.setRequestHeader("Content-Type",d.contentType);if(d.ifModified){T[d.url]&&r.setRequestHeader("If-Modified-Since",T[d.url]);ca[d.url]&&
r.setRequestHeader("If-None-Match",ca[d.url])}r.setRequestHeader("X-Requested-With","XMLHttpRequest");r.setRequestHeader("Accept",d.dataType&&d.accepts[d.dataType]?d.accepts[d.dataType]+", */*":d.accepts._default)}catch(da){}if(d.beforeSend&&d.beforeSend.call(j,r,d)===false){r.abort();return false}var aa=function(fa){if(!r||r.readyState===0){if(R){clearInterval(R);R=null}}else if(!t&&r&&(r.readyState===4||fa==="timeout")){t=true;if(R){clearInterval(R);R=null}var C;if(fa==="timeout")C="timeout";else{a:{try{C=
!r.status&&location.protocol==="file:"||r.status>=200&&r.status<300||r.status===304||r.status===1223||r.status===0;break a}catch(ka){}C=false}if(C){if(C=d.ifModified){C=r;var ga=d.url,ta=C.getResponseHeader("Last-Modified"),va=C.getResponseHeader("Etag");if(ta)T[ga]=ta;if(va)ca[ga]=va;C=C.status===304||C.status===0}C=C?"notmodified":"success"}else C="error";C=C}f=C;if(f==="success")try{C=r;var Z=d.dataType;ga=d;var G=C.getResponseHeader("content-type"),N=Z==="xml"||!Z&&G&&G.indexOf("xml")>=0,$=N?
C.responseXML:C.responseText;if(N&&$.documentElement.nodeName==="parsererror")throw"parsererror";if(ga&&ga.dataFilter)$=ga.dataFilter($,Z);if(typeof $==="string")if(Z==="json")$=typeof U==="object"&&U.parse?U.parse($):(new Function("return "+$))();h=$}catch(xa){f="parsererror"}if(f==="success"||f==="notmodified")d.success&&d.success.call(j,h,f);else if(d.error)d.error.call(d.context||y,r,f,void 0);d.complete&&d.complete.call(j,r,f);fa&&r.abort();if(d.async)r=null}};if(d.async){var R=setInterval(aa,
13);d.timeout>0&&setTimeout(function(){r&&!t&&aa("timeout")},d.timeout)}try{r.send(k==="POST"||k==="PUT"?d.data:null)}catch(ma){if(d.error)d.error.call(d.context||y,r,null,ma)}d.async||aa();return r}function A(){}function S(d){function f(){t=true;y[k]=ba;try{delete y[k]}catch(r){}o.onload=o.onreadystatechange=null;n&&o.parentNode&&n.removeChild(o)}d=w({},d);var h=""+la(d.data),j=d.context||y,k="jsonp"+u++,n=v.getElementsByTagName("head")[0]||v.documentElement,o=v.createElement("script");h=(h?h+"&":
"")+(d.jsonp||"callback")+"="+k;d.url+=(z.test(d.url)?"&":"?")+h;o.src=d.url;if(d.scriptCharset)o.charset=d.scriptCharset;var t=false;y[k]=function(r){d.success&&d.success.call(j,r,"success");f()};o.onload=o.onreadystatechange=function(){if(!t&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){d.error&&d.error.call(j,"error");f()}};d.timeout>0&&setTimeout(function(){if(!t){d.error&&d.error.call(j,"timeout");f();y[k]=A}},d.timeout);n.insertBefore(o,n.firstChild);return ba}
function s(d,f){this._setting();this.options={jsonp:false,server:null,ticket:null,domain:null,timeout:4E4,url:{send:null}};w(this.options,f)}function ua(d,f,h){if(typeof f!="undefined"){h=h||{};if(f===null){f="";h=w({},h);h.expires=-1}var j="";if(h.expires&&(typeof h.expires=="number"||h.expires.toUTCString)){if(typeof h.expires=="number"){j=new Date;j.setTime(j.getTime()+h.expires*24*60*60*1E3)}else j=h.expires;j="; expires="+j.toUTCString()}var k=h.path?"; path="+h.path:"",n=h.domain?"; domain="+
h.domain:"";h=h.secure?"; secure":"";v.cookie=[d,"=",encodeURIComponent(f),j,k,n,h].join("")}else{f=null;if(v.cookie&&v.cookie!=""){h=v.cookie.split(";");for(j=0;j<h.length;j++){k=ia(h[j]);if(k.substring(0,d.length+1)==d+"="){f=decodeURIComponent(k.substring(d.length+1));break}}}return f}}function J(d,f){if(na){var h=new Date,j=["[",h.getHours(),":",h.getMinutes(),":",h.getSeconds(),"-",h.getMilliseconds(),"]"].join("");h=j+f+U.encode(d);y.console&&y.console.log(j,f,d);j=v.getElementById("webim-log")||
v.body;y.air&&y.air.trace(h);if(j){var k=v.createElement("P");k.innerHTML=h;j.appendChild(k)}}}function O(d,f){this.options=w({},O.defaults,f);this._init(d,f)}function oa(d){return d&&d.split?d.split(","):Y(d)?d:parseInt(d)?[parseInt(d)]:[]}function V(d,f,h){function j(k,n){this.data=k;this.options=w({},j.defaults,n);W(this._init)&&this._init()}j.defaults=f;w(j.prototype,P,h);O[d]=j}var ra=Object.prototype.toString,P={option:function(d,f){var h=d;this.options=this.options||{};if(typeof d=="string"){if(f===
ba)return this.options[d];h={};h[d]=f}w(this.options,h);return this},bind:function(d,f){var h=this._events=this._events||{};if(W(f)){h[d]=h[d]||[];h[d].push(f)}return this},trigger:function(d,f){var h=(this._events=this._events||{})[d];if(!h)return this;f=Y(f)?f:E(f);for(var j=0,k=h.length;j<k;j++)h[j].apply(this,f);return this},unbind:function(d,f){var h=this._events=this._events||{};if(!h[d])return this;if(W(f)){h=h[d];for(var j=h.length;j--;)if(h[j]===f||h[j]===f._proxy)h.splice(j,1)}else delete h[d];
return this},one:function(d,f){if(!W(f))return this;var h=this,j=f._proxy=fun._proxy||function(){h.unbind(d,j);return f.apply(this,arguments)};h.bind(d,j)}},u=qa(),z=/\?/,sa=/(\?|&)_=.*?(&|$)/,F=/%20/g,I={url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return y.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest},accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",
json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}},T={},ca={},U=function(){function d(j){return h[j]||"\\u00"+Math.floor(j.charCodeAt()/16).toString(16)+(j.charCodeAt()%16).toString(16)}function f(j){switch(Object.prototype.toString.call(j)){case "[object String]":return'"'+j.replace(/[\x00-\x1f\\"]/g,d)+'"';case "[object Array]":for(var k=[],n=j.length,o=0;o<n;o++)k.push(f(j[o]));return"["+k.join(",")+"]";case "[object Object]":k=[];for(n in j)(o=f(j[n]))&&k.push(f(n)+":"+
o);return"{"+k+"}";case "[object Number]":case "[object Boolean]":return String(j);case false:return"null"}return null}var h={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return{encode:f,decode:function(j){j=j.toString();if(!j||!j.length)return null;return(new Function("return "+j))()}}}();w(s.prototype,P,{_setting:function(){this._onPolling=this._connecting=this.connected=false;this._pollTimer=null;this._failTimes=this._pollingTimes=0},connect:function(d){var f=
this;w(f.options,d);if(f._connecting)return f;f._connecting=true;d=f.options;f._onPolling||y.setTimeout(function(){f._startPolling()},300);return f},close:function(){this._pollTimer&&clearTimeout(this._pollTimer);this._setting();return this},_onConnect:function(){this.connected=true;this.trigger("connect","success")},_onClose:function(d){this._setting();this.trigger("close",[d])},_onData:function(d){this.trigger("data",d)},_onError:function(d){this._setting();this.trigger("error",d)},_startPolling:function(){var d=
this.options;this._onPolling=true;this._pollingTimes++;var f={url:d.server,data:{domain:d.domain,ticket:d.ticket},dataType:"json",timeout:d.timeout,cache:false,context:this,success:this._onPollSuccess,error:this._onPollError};if(d.jsonp){w(f,{timeout:d.timeout,dataType:"jsonp",jsonp:"callback"});S(f)}else D(f)},_onPollSuccess:function(d){var f=this;f._onPolling=false;if(f._connecting)if(!d||!d.status)return f._onError("error data");else{f._pollingTimes==1&&f._onConnect();f._onData(d);f._failTimes=
0;f._pollTimer=y.setTimeout(function(){f._startPolling()},200)}},_onPollError:function(d){var f=this;f._onPolling=false;if(f._connecting){f._failTimes++;if(f._pollingTimes==1)f._onError("can not connect.");else if(f._failTimes>1)f._onClose(d);else f._pollTimer=y.setTimeout(function(){f._startPolling()},200)}}});var na=true;J.enable=function(){na=true};J.disable=function(){na=false};w(O.prototype,P,{_init:function(){var d=this.options,f={presence:"offline",show:"unavailable"};this.request=d.jsonp?
S:D;this.data={user:f};this.status=new O.status;this.setting=new O.setting(null,{jsonp:d.jsonp});this.buddy=new O.buddy(null,{active:this.status.get("b"),jsonp:d.jsonp});this.room=new O.room(null,{user:f,jsonp:d.jsonp});this.history=new O.history(null,{user:f,jsonp:d.jsonp});this.connection=new s(null,{jsonp:true});this._initEvents()},user:function(d){w(this.data.user,d)},_ready:function(d){var f=this;f._unloadFun=y.onbeforeunload;y.onbeforeunload=function(){f._refresh()};f.trigger("ready",[d])},
_go:function(){var d=this.data,f=this.history,h=this.buddy,j=this.room;f.option("userInfo",d.user);M(d.buddies,function(n,o){f.init("unicast",o.id,o.history)});h.handle(d.buddies);M(d.rooms,function(n,o){f.init("multicast",o.id,o.history)});h=this.setting.get("blocked_rooms");var k=d.rooms;Y(h)&&k&&M(h,function(n,o){k[o]&&(k[o].blocked=true)});j.handle(k);j.options.ticket=d.connection.ticket;this.trigger("go",[d]);this.connection.connect(d.connection);if((d=d.new_messages)&&d.length){M(d,function(n,
o){o["new"]=true});this.trigger("message",[d])}},_stop:function(d){y.onbeforeunload=this._unloadFun;this.data.user.presence="offline";this.data.user.show="unavailable";this.buddy.clear();this.trigger("stop",d)},autoOnline:function(){return!this.status.get("o")},_initEvents:function(){function d(k){var n={id:k.from,presence:k.type};if(k.show)n.show=k.show;if(k.nick)n.nick=k.nick;if(k.status)n.status=k.status;return n}var f=this,h=f.history,j=f.buddy;f.connection.bind("connect",function(){}).bind("data",
function(k){f.handle(k)}).bind("error",function(){f._stop("connect error")}).bind("close",function(){f._stop("disconnect")});f.bind("message",function(k){for(var n=[],o=k.length,t=f.data.user.id,r,da,aa,R=0;R<o;R++){r=k[R];aa=r.type;da=aa=="unicast"?r.to==t?r.from:r.to:r.to;r.id=da;if(aa=="unicast"&&!r["new"]){da={id:da,presence:"online"};if(r.nick)da.nick=r.nick;n.push(da)}}if(n.length){j.presence(n);j.complete()}h.handle(k)});f.bind("presence",function(k){j.presence(ja(k,d))})},handle:function(d){d.messages&&
d.messages.length&&this.trigger("message",[d.messages]);d.presences&&d.presences.length&&this.trigger("presence",[d.presences]);d.statuses&&d.statuses.length&&this.trigger("status",[d.statuses])},sendMsg:function(d){d.ticket=this.data.connection.ticket;this.trigger("sendMsg",[d]);this.request({type:"post",url:this.options.urls.message,cache:false,data:d})},sendStatus:function(d){d.ticket=this.data.connection.ticket;this.request({type:"post",url:this.options.urls.status,cache:false,data:d})},sendPresence:function(d){d.ticket=
this.data.connection.ticket;this.data.user.show=d.show;this.status.set("s",d.show);this.request({type:"post",url:this.options.urls.presence,cache:false,data:d})},online:function(d){var f=this,h=f.status,j=[],k=[],n=h.get("tabs"),o=h.get("tabIds");o&&o.length&&n&&M(n,function(t){t[0]=="b"&&j.push(t.slice(2));t[0]=="r"&&k.push(t.slice(2))});d=w({buddy_ids:j.join(","),room_ids:k.join(","),show:h.get("s")||"available"},d);f._ready(d);h.set("o",false);h.set("s",d.show);f.request({type:"post",dataType:"json",
data:d,url:f.options.urls.online,success:function(t){if(!t||!t.user||!t.connection)f._stop("online error");else{t.user=w(f.data.user,t.user,{presence:"online"});f.data=t;f._go()}},error:function(){f._stop("online error")}})},offline:function(){var d=this.data;this.status.set("o",true);this.connection.close();this._stop("offline");this.request({type:"post",url:this.options.urls.offline,type:"post",cache:false,data:{status:"offline",ticket:d.connection.ticket}})},_refresh:function(){var d=this.data;
!d||!d.connection||!d.connection.ticket||this.request({type:"post",url:this.options.urls.refresh,type:"post",cache:false,data:{ticket:d.connection.ticket}})}});y.webim=O;w(O,{version:"1.0.1",defaults:{urls:{online:"webim/online",offline:"webim/offline",message:"webim/message",presence:"webim/presence",refresh:"webim/refresh",status:"webim/status"}},log:J,idsArray:oa,now:qa,isFunction:W,isArray:Y,isObject:ea,trim:ia,makeArray:E,extend:w,each:M,inArray:function(d,f){for(var h=0,j=f.length;h<j;h++)if(f[h]===
d)return h;return-1},grep:function(d,f,h){for(var j=[],k=0,n=d.length;k<n;k++)!h!==!f(d[k],k)&&j.push(d[k]);return j},map:ja,JSON:U,ajax:D,comet:s,model:V,objectExtend:P});V("setting",{url:"/webim/setting",data:{blocked_rooms:[],play_sound:true,buddy_sticky:true,minimize_layout:true,msg_auto_pop:true}},{_init:function(){this.request=this.options.jsonp?S:D;this.data=w({},this.options.data,this.data)},get:function(d){return this.data[d]},set:function(d,f){var h=this,j=d;if(d){if(typeof d=="string"){j=
{};j[d]=f}var k=h.data,n=X(k,j);if(n){M(n,function(o,t){h.trigger("update",[o,t])});j=w({},k,j);h.data=j;h.request({type:"post",url:h.options.url,dataType:"json",cache:false,data:{data:U.encode(j)}})}}}});V("status",{key:"_webim"},{_init:function(){var d=this.data;if(d)this._save(d);else this.data=(d=ua(this.options.key))?U.decode(d):{}},set:function(d,f){var h=d;if(typeof d=="string"){h={};h[d]=f}var j=this.data;X(j,h)&&this._save(w({},j,h))},get:function(d){return this.data[d]},clear:function(){this._save({})},
_save:function(d){this.data=d;ua(this.options.key,U.encode(d),{path:"/",domain:v.domain})}});V("buddy",{url:"/webim/buddy"},{_init:function(){this.request=this.options.jsonp?S:D;this.data=this.data||[];this.dataHash={};this.handle(this.data)},clear:function(){this.data=[];this.dataHash={}},count:function(d){var f=this.dataHash,h=0,j;for(var k in f)if(ea(d)){j=true;for(var n in d)if(d[n]!=f[k][n])j=false;j&&h++}else h++;return h},get:function(d){return this.dataHash[d]},complete:function(){var d=this.dataHash,
f=[],h;for(var j in d){h=d[j];if(h.incomplete&&h.presence=="online"){h.incomplete=false;f.push(j)}}this.load(f)},update:function(d){this.load(d)},presence:function(d){var f=this.dataHash;d=Y(d)?d:[d];for(var h in d){var j=d[h];j.presence=j.presence=="offline"?"offline":"online";j.incomplete=!f[j.id]}this.handle(d)},load:function(d){d=oa(d);d.length&&this.request({type:"get",url:this.options.url,cache:false,dataType:"json",data:{ids:d.join(",")},context:this,success:this.handle})},handle:function(d){var f=
this.data,h=this.dataHash,j={};d=d||[];var k,n;for(var o in d){k=d[o];if(id=k.id){if(!h[id]){k.presence=k.presence||"online";k.show=k.show?k.show:k.presence=="offline"?"unavailable":"available";h[id]={};f.push(h[id])}k.incomplete=!!k.incomplete;if(n=X(h[id],k)){k=n.presence||"update";j[k]=j[k]||[];w(h[id],n);j[k].push(h[id])}}}for(var t in j)this.trigger(t,[j[t]]);this.options.active&&this.complete()}});(function(){V("room",{urls:{join:"/webim/join",leave:"/webim/leave",member:"/webim/members"}},
{_init:function(){this.data=this.data||[];this.dataHash={};this.request=this.options.jsonp?S:D},get:function(d){return this.dataHash[d]},block:function(d){var f=this.dataHash[d];if(f&&!f.blocked){f.blocked=true;var h=[];M(this.dataHash,function(j,k){k.blocked&&h.push(k.id)});this.trigger("block",[d,h])}},unblock:function(d){var f=this.dataHash[d];if(f&&f.blocked){f.blocked=false;var h=[];M(this.dataHash,function(j,k){k.blocked&&h.push(k.id)});this.trigger("unblock",[d,h])}},handle:function(d){var f=
this,h=f.data,j=f.dataHash;M(d,function(k,n){var o=n.id;if(o){n.members=n.members||[];n.count=n.count||0;n.all_count=n.all_count||0;if(j[o])w(j[o],n);else{j[o]=n;h.push(n)}f.trigger("join",[j[o]])}})},addMember:function(d,f){var h=this;if(Y(f))M(f,function(t,r){h.addMember(d,r)});else{var j=h.dataHash[d];if(j){for(var k=j.members,n,o=k.length;o--;)if(k[o].id==f.id)n=k[o];if(!n){f.nick=f.nick;k.push(f);j.count=k.length;h.trigger("addMember",[d,f])}}}},removeMember:function(d,f){var h=this.dataHash[d];
if(h){for(var j=h.members,k,n=j.length;n--;)if(j[n].id==f){k=j[n];j.splice(n,1);h.count--}k&&self.trigger("removeMember",[d,k])}},initMember:function(d){var f=this.dataHash[d];if(f&&!f.initMember){f.initMember=true;this.loadMember(d)}},loadMember:function(d){var f=this,h=f.options;f.request({type:"get",cache:false,url:h.urls.member,dataType:"json",data:{ticket:h.ticket,id:d},success:function(j){f.addMember(d,j)}})},join:function(d){var f=this,h=f.options;f.request({cache:false,type:"post",url:h.urls.join,
dataType:"json",data:{ticket:h.ticket,id:d,nick:h.user.nick},success:function(j){f.initMember(d);f.handle([j])}})},leave:function(d){var f=this.options,h=this.dataHash[d],j=f.user;if(h){h.initMember=false;this.request({cache:false,type:"post",url:f.urls.leave,data:{ticket:f.ticket,id:d,nick:j.nick}});this.trigger("leave",[h])}},clear:function(){}})})();V("history",{urls:{load:"webim/history",clear:"webim/clear_history"}},{_init:function(){this.data=this.data||{};this.data.unicast=this.data.unicast||
{};this.data.multicast=this.data.multicast||{};this.request=this.options.jsonp?S:D},unicast:function(d){return this.data.unicast[d]},multicast:function(d){return this.data.multicast[d]},handle:function(d){var f=this.data,h={unicast:{},multicast:{}};d=E(d);var j=d.length,k,n,o=this.options.userInfo.id;if(j){for(var t=0;t<j;t++){k=d[t];r=k.type;if((n=r=="unicast"?k.to==o?k.from:k.to:k.to)&&r){h[r][n]=h[r][n]||[];h[r][n].push(k)}}for(var r in h)for(n in h[r]){k=h[r][n];if(f[r][n]){f[r][n]=f[r][n].concat(k);
this._triggerMsg(r,n,k)}else this.load(r,n)}}},_triggerMsg:function(d,f,h){this.trigger(d,[f,h])},clear:function(d,f){var h=this.options;this.data[d][f]=[];this.trigger("clear",[d,f]);this.request({url:h.urls.clear,type:"post",cache:false,data:{type:d,id:f}})},init:function(d,f,h){if(Y(h)){this.data[d][f]=h;this._triggerMsg(d,f,h)}},load:function(d,f){var h=this,j=h.options;h.data[d][f]=[];h.request({url:j.urls.load,cache:false,type:"get",dataType:"json",data:{type:d,id:f},success:function(k){h.init(d,
f,k)}})}})})(window,document);
(function(y,v,ba){function qa(){return false}function W(a){var b="";if(a.length==0)return"";b=a.replace(/&/g,"&gt;");b=b.replace(/</g,"&lt;");b=b.replace(/>/g,"&gt;");b=b.replace(/    /g,"&nbsp;");b=b.replace(/\'/g,"&#39;");b=b.replace(/\"/g,"&quot;");return b=b.replace(/\n/g,"<br />")}function Y(a){return/^http:\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"])*$/.test(a)}function ea(a){return a?a.replace(/<(?:.|\s)*?>/g,""):""}function ia(a,b){for(var c=[];a;a=a.nextSibling)a.nodeType==
1&&a!=b&&c.push(a);return c}function X(a,b){return a&&RegExp("(^|\\s+)"+b+"(\\s+|$)").test(a.className)}function E(a,b){if(a)X(a,b)||(a.className+=" "+b)}function w(a,b){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," "))}function M(a,b,c){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," ")+" "+c)}function ja(a,b,c){s(a,"mouseover",function(){E(this,b);c&&w(this,c)});s(a,"mouseout",function(){w(this,
b);c&&E(this,c)})}function la(a,b,c){if(typeof c==="boolean")c?E(a,b):w(a,b);else X(a,b)?w(a,b):E(a,b)}function D(a){a&&a.style&&(a.style.display="block")}function A(a){a&&a.style&&(a.style.display="none")}function S(a){a&&a.parentNode&&a.parentNode.removeChild(a)}function s(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else{a["e"+b+c]=c;a[b+c]=function(){return a["e"+b+c](y.event)};a.attachEvent("on"+b,a[b+c])}}function ua(a){if(a){a.stopPropagation&&a.stopPropagation();a.cancelBubble=
true}}function J(a){if(a){a.preventDefault&&a.preventDefault();a.returnValue=false}}function O(a){if(!a.target)a.target=a.srcElement||v;if(a.target.nodeType===3)a.target=a.target.parentNode;return a.target}function oa(a){a.setAttribute("unselectable","on");a.style.MozUserSelect="none";s(a,"selectstart",qa)}function V(){if(!ma){ma=true;if(fa){for(var a,b=0;a=fa[b++];)a();fa=null}}}function ra(){if(!C){C=true;if(v.readyState==="complete")return V();if(v.addEventListener)v.addEventListener("DOMContentLoaded",
function(){v.removeEventListener("DOMContentLoaded",arguments.callee,false);V()},false);else if(v.attachEvent){v.attachEvent("onreadystatechange",function(){if(v.readyState==="complete"){v.detachEvent("onreadystatechange",arguments.callee);V()}});v.documentElement.doScroll&&y==y.top&&function(){if(!ma){try{v.documentElement.doScroll("left")}catch(a){setTimeout(arguments.callee,0);return}V()}}()}s(y,"load",V)}}function P(a){var b=new Date;b.setTime(a?parseFloat(a)+P.timeSkew:(new Date).getTime());
this.date=b}function u(a,b,c){c=n({locale:u.locale},c);c=u.dictionary[c.locale];h(c)||(c={});a=c[a]===ba?a:c[a];if(b){ta=b;for(var e in b)a=a.replace(/\{\{(.*?)\}\}/g,va)}return a}function z(a,b){this.element=a;this.options=n({},z.defaults,b);this._init()}function sa(a){a=a.getElementsByTagName("*");for(var b,c,e={},g=a.length-1;g>-1;g--){b=a[g];if((c=b.id)&&c.indexOf(":")==0)e[c.substring(1,c.length)]=b}return e}function F(a){var b=v.createElement("div");b.innerHTML=a;return b=b.firstChild}function I(a,
b,c){function e(g,i){this.id=$++;this.name=a;this.className="webim-"+a;this.options=n({},e.defaults,i);if(this.element=g||this.template&&F(this.template())||this.options.template&&F(G(this.options.template))){this.options.className&&E(this.element,this.options.className);this.$=sa(this.element)}d(this._init)&&this._init();d(this._initEvents)&&this._initEvents()}e.defaults=b;n(e.prototype,aa,I.prototype,c);z[a]=e}function T(a,b){z.apps[a]=b||{}}function ca(a,b){return b?a=="b"||a=="buddy"||a=="unicast"?
"b_"+b:"r_"+b:a}function U(){v.selection&&(this.caretPos=v.selection.createRange())}var na=webim.idsArray,d=webim.isFunction,f=webim.isArray,h=webim.isObject,j=webim.trim,k=webim.makeArray,n=webim.extend,o=webim.each,t=webim.grep,r=webim.ajax,da=webim.model,aa=webim.objectExtend,R=webim.map,ma=false,fa=[],C=false;P.timeSkew=0;P.init=function(a){P.timeSkew=(new Date).getTime()-parseFloat(a)};n(P.prototype,{getTime:function(){var a=this.date,b=a.getHours();a=a.getMinutes();if(a<10)a="0"+a;return b+
":"+a+""},getDay:function(a){var b=this.date;if(a){a=new Date;a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);a=a.getTime()-b.getTime();if(a<=0)return u("dt:today");else if(a<864E5)return u("dt:yesterday")}return u("dt:monthdate",{month:u(["dt:january","dt:february","dt:march","dt:april","dt:may","dt:june","dt:july","dt:august","dt:september","dt:october","dt:november","dt:december"][b.getMonth()]),date:b.getDate()})}});var ka=function(){var a=true,b={lib:"sound.swf",msg:"sound/msg.mp3"};
return{enable:function(){a=true},disable:function(){a=false},init:function(c){n(b,c);c=b.lib+"?_"+(new Date).getTime();c=navigator.plugins&&navigator.mimeTypes&&navigator.mimeTypes.length?'<embed type="application/x-shockwave-flash" width="10" height="10" id="webim-flashlib" allowscriptaccess="always" src="'+c+'" />':'<object width="10" height="10" id="webim-flashlib" type="application/x-shockwave-flash" data="'+c+'">\t\t\t\t<param name="allowScriptAccess" value="always" />\t\t\t\t<param name="movie" value="'+
c+'" />\t\t\t\t<param name="scale" value="noscale" />\t\t\t\t</object>';try{v.getElementById("webim-flashlib-c").innerHTML=c}catch(e){}},play:function(c){c=Y(c)?c:b[c];if(a)try{v.getElementById("webim-flashlib").playSound(c?c:"/sound/sound.mp3")}catch(e){}}}}(),ga=function(){var a=false;s(y,"focus",function(){a=false});s(y,"blur",function(){a=true});var b=v.title,c=0,e=false;return function(g,i){if(a){if(m){clearInterval(m);c=0;e=false}var m=setInterval(function(){c++;e=!e;if(c==i||!a){clearInterval(m);
c=0;e=false}v.title=e?"["+g+"]"+b:b},1500)}}}(),ta={},va=function(a,b){return ta[b]||""};u.locale="zh-CN";u.dictionary={};u.store=function(a,b){var c=u.dictionary;h(c[a])||(c[a]={});n(c[a],b)};n(z.prototype,aa,{render:function(){var a=this,b=a.layout;a.element.appendChild(b.element);setTimeout(function(){a.initSound()},1E3);b.buildUI()},_init:function(){var a=this.im=new webim(null,this.options.imOptions),b=this.options;b=this.layout=new z.layout(null,n({chatAutoPop:a.setting.get("msg_auto_pop")},
b.layoutOptions));a.setting.get("play_sound")?ka.enable():ka.disable();a.setting.get("minimize_layout")?b.collapse():b.expand();this._initEvents()},addApp:function(a,b){var c=z.apps[a];if(c){var e=this,g=e.im;d(c.init)&&c.init.apply(e,[b]);d(c.ready)&&g.bind("ready",function(){c.ready.apply(e,arguments)});d(c.go)&&g.bind("go",function(){c.go.apply(e,arguments)});d(c.stop)&&g.bind("stop",function(){c.stop.apply(e,arguments)})}},initSound:function(a){ka.init(a||this.options.soundUrls)},_initEvents:function(){var a=
this,b=a.im,c=b.buddy,e=b.history,g=b.setting,i=a.layout,m=b.room;b.bind("ready",function(){i.changeState("ready")}).bind("go",function(l){i.changeState("active");i.option("user",l.user);P.init(l.server_time);a._initStatus()}).bind("stop",function(l){l=="offline"&&i.removeAllChat();i.updateAllChat();i.changeState("stop")});g.bind("update",function(l,p){switch(l){case "play_sound":p?ka.enable():ka.disable();break;case "msg_auto_pop":i.option("chatAutoPop",p);break;case "minimize_layout":p?i.collapse():
i.expand();break}});c.bind("online",function(l){i.updateChat("buddy",l)}).bind("offline",function(l){i.updateChat("buddy",l)}).bind("update",function(l){i.updateChat("buddy",l)});m.bind("addMember",function(l,p){var q=i.chat("room",l);q&&q.addMember(p.id,p.nick,p.id==b.data.user.id)}).bind("removeMember",function(l,p){var q=i.chat("room",l);q&&q.removeMember(p.id,p.nick)});i.bind("collapse",function(){g.set("minimize_layout",true)});i.bind("expand",function(){g.set("minimize_layout",false)});i.bind("displayUpdate",
function(){a._updateStatus()});b.bind("message",function(l){for(var p=false,q=l.length,x,H=b.data.user.id,K,L,B=0;B<q;B++){x=l[B];K=x.id;type=x.type;(L=i.chat(type,K))&&L.status("");if(!L){x.type==="unicast"?a.addChat(type,K,null,null,x.nick):a.addChat(type,K);L=i.chat(type,K)}L&&g.get("msg_auto_pop")&&!i.activeTabId&&i.focusChat(K);L.window.notifyUser("information","+1");K=L.window.pos;K==-1&&i.setNextMsgNum("+1");K==1&&i.setPrevMsgNum("+1");if(x.from!=H)p=true}if(p){ka.play("msg");ga(u("new message"),
5)}});b.bind("status",function(l){o(l,function(p,q){var x=b.data.user.id,H=q.from;if(!(x!=q.to&&x!=q.from))(x=i.chat("buddy",H))&&x.status(q.show)})});e.bind("unicast",function(l,p){var q=i.chat("unicast",l);q&&q.history.add(p)});e.bind("multicast",function(l,p){var q=i.chat("multicast",l);q&&q.history.add(p)});e.bind("clear",function(l,p){var q=i.chat(l,p);q&&q.history.clear()})},__status:false,_initStatus:function(){var a=this,b=a.layout;if(a.__status)return b.updateAllChat();a.__status=true;var c=
a.im.status,e=c.get("tabs"),g=c.get("tabIds"),i=c.get("p");c=c.get("a");g&&g.length&&e&&o(e,function(m,l){var p=m.slice(2),q=m.slice(0,1);a.addChat(q,p,{},{isMinimize:true});b.chat(m).window.notifyUser("information",l.n)});i&&(b.prevCount=i)&&b._fitUI();c&&b.focusChat(c)},addChat:function(a,b,c,e,g){a=a=="b"||a=="buddy"||a=="unicast"?"buddy":"room";var i=this,m=i.layout,l=i.im,p=i.im.history,q=l.buddy,x=l.room,H=i.options;if(!m.chat(a,b))if(a=="room"){c=n({},H.roomChatOptions,c);H=p.multicast(b);
var K=x.get(b);g=K||{id:b,nick:g||b};g.presence="online";m.addChat(a,g,n({history:H,block:true,emot:true,clearHistory:false,member:true,msgType:"multicast"},c),e);H||p.load("multicast",b);var L=m.chat(a,b);L.bind("sendMsg",function(B){l.sendMsg(B);p.handle(B)}).bind("select",function(B){q.online(B.id);i.addChat("buddy",B.id,null,null,B.nick);m.focusChat("buddy",B.id)}).bind("block",function(B){x.block(B.id)}).bind("unblock",function(B){x.unblock(B.id)}).window.bind("close",function(){L.options.info.blocked&&
x.leave(b)});setTimeout(function(){L.options.info.blocked?x.join(b):x.initMember(b)},500);f(g.members)&&o(g.members,function(B,Q){L.addMember(Q.id,Q.nick,Q.id==l.data.user.id)})}else{c=n({},H.buddyChatOptions,c);H=p.unicast(b);g=(K=q.get(b))||{id:b,nick:g||b};m.addChat(a,g,n({history:H,block:false,emot:true,clearHistory:true,member:false,msgType:"unicast"},c),e);K||q.update(b);H||p.load("unicast",b);m.chat(a,b).bind("sendMsg",function(B){l.sendMsg(B);p.handle(B)}).bind("sendStatus",function(B){l.sendStatus(B)}).bind("clearHistory",
function(B){p.clear("unicast",B.id)})}},_updateStatus:function(){var a=this.layout,b={};o(a.tabs,function(c,e){b[c]={n:e._count()}});this.im.status.set({tabs:b,tabIds:a.tabIds,p:a.prevCount,a:a.activeTabId})}});var Z=function(a,b){if(b===ba)return parseInt(a.innerHTML);else if(b){b=typeof b=="number"?b:parseInt(a.innerHTML)+parseInt(b);a.innerHTML=b.toString();D(a)}else{a.innerHTML="0";A(a)}return b},G=function(){function a(e,g){return b&&b[g]!=ba?b[g]:u(g)}var b=null,c=/\<\%\=(.*?)\%\>/ig;return function(e,
g){if(!e)return"";b=g;return e.replace(c,a)}}(),N={add:function(a,b,c){a=z[a].prototype;for(var e in c){a.plugins[e]=a.plugins[e]||[];a.plugins[e].push([b,c[e]])}},call:function(a,b,c){if((b=a.plugins[b])&&a.element.parentNode)for(var e=0;e<b.length;e++)a.options[b[e][0]]&&b[e][1].apply(a.element,c)}},$=1;n(I.prototype,{_init:function(){}});n(z,{version:"3.0.1",widget:I,app:T,plugin:N,i18n:u,date:P,ready:function(a){ra();ma?a():fa.push(a)},createElement:F,defaults:{},apps:{}});webim.ui=z;I("window",
{isMinimize:false,minimizable:true,maximizable:false,closeable:true,sticky:true,titleVisibleLength:12,count:0,template:'<div id=":webim-window" class="webim-window ui-widget">                                            <div class="webim-window-tab-wrap">                                            <div id=":tab" class="webim-window-tab ui-state-default">                                            <div class="webim-window-tab-inner">                                                    <div id=":tabTip" class="webim-window-tab-tip">                                                            <strong id=":tabTipC"><%=tooltip%></strong>                                                    </div>                                                    <a id=":tabClose" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                    <div id=":tabCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <em id=":tabIcon" class="webim-icon webim-icon-comments"></em>                                                    <h4 id=":tabTitle"><%=title%></h4>                                            </div>                                            </div>                                            </div>                                            <div><div id=":window" class="webim-window-window">\t\t\t\t\t\t<iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe>                                                    <div id=":header" class="webim-window-header ui-widget-header ui-corner-top">                                                            <span id=":actions" class="webim-window-actions">                                                                    <a id=":minimize" title="<%=minimize%>" class="webim-window-minimize" href="#minimize"><em class="ui-icon ui-icon-minus"><%=minimize%></em></a>                                                                    <a id=":maximize" title="<%=maximize%>" class="webim-window-maximize" href="#maximize"><em class="ui-icon ui-icon-plus"><%=maximize%></em></a>                                                                    <a id=":close" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                            </span>                                                            <h4 id=":headerTitle"><%=title%></h4>                                                            <div id=":subHeader" class="webim-window-subheader"></div>                                                    </div>                                                    <div id=":content" class="webim-window-content ui-widget-content">                                                    </div>                                            </div>                                            </div>                                            </div>'},
{html:function(a){return this.$.content.appendChild(a)},subHeader:function(a){this.$.subHeader.innerHTML="";return this.$.subHeader.appendChild(a)},_init:function(a,b){b=this.options;var c=this.$;a=this.element;a.window=this;b.tabWidth&&(c.tab.style.width=b.tabWidth+"px");b.subHeader&&this.subHeader(b.subHeader);this.title(b.title,b.icon);!b.minimizable&&A(c.minimize);!b.maximizable&&A(c.maximize);if(!b.closeable){A(c.tabClose);A(c.close)}b.isMinimize?this.minimize():this.restore();b.onlyIcon?A(c.tabTitle):
S(c.tabTip);b.count&&this.notifyUser("information",b.count);xa(this)},notifyUser:function(a,b){var c=this.$;if(a=="information")if(this.isMinimize())if(Z(c.tabCount,b)){E(c.tab,"ui-state-highlight");w(c.tab,"ui-state-default")}},_count:function(){return Z(this.$.tabCount)},title:function(a,b){var c=this.$,e=c.tabIcon;if(b)if(Y(b)){e.className="webim-icon";e.style.backgroundImage="url("+b+")"}else e.className="webim-icon webim-icon-"+b;c.tabTipC.innerHTML=a;e=this.options.titleVisibleLength;if(a){for(var g=
0,i=[],m=a.split(""),l=m.length,p=0;p<l;p++)if(g>=e||g<0)break;else{if(m[p].charCodeAt(0)>255)g+=2;else g++;i.push(m[p])}e=i.join("")}else e=a;(c.tabTitle.innerHTML=e)&&a&&e.length<a.length&&c.tabTitle.setAttribute("title",a);c.headerTitle.innerHTML=a},_changeState:function(a){M(this.element,"webim-window-normal webim-window-maximize webim-window-minimize","webim-window-"+(a=="restore"?"normal":a));this.trigger("displayStateChange",[a])},active:function(){return X(this.element,"webim-window-active")},
activate:function(){if(!this.active()){E(this.element,"webim-window-active");this.trigger("activate")}},deactivate:function(){if(this.active()){w(this.element,"webim-window-active");this.options.sticky||this.minimize();this.trigger("deactivate")}},_setVisibile:function(){var a=this.$;M(a.tab,"ui-state-default ui-state-highlight","ui-state-active");this.activate();Z(a.tabCount,0)},maximize:function(){if(!this.isMaximize()){this._setVisibile();this._changeState("maximize")}},restore:function(){if(!X(this.element,
"webim-window-normal")){this._setVisibile();this._changeState("restore")}},minimize:function(){if(!this.isMinimize()){M(this.$.tab,"ui-state-active","ui-state-default");this.deactivate();this._changeState("minimize")}},tabClose:function(){this.close()},close:function(){this.trigger("close");S(this.element)},_initEvents:function(){var a=this,b=a.$,c=b.tab,e=function(g){ua(g);J(g)};s(c,"click",function(g){a.isMinimize()?a.restore():a.minimize();e(g)});s(c,"mouseover",function(){E(this,"ui-state-hover");
w(this,"ui-state-default")});s(c,"mouseout",function(){w(this,"ui-state-hover");this.className.indexOf("ui-state-")==-1&&E(this,"ui-state-default")});s(c,"mousedown",e);oa(c);o(ia(b.actions.firstChild),function(g,i){ja(i,"ui-state-hover")});o(["minimize","maximize","close","tabClose"],function(g,i){s(b[i],"click",function(m){this.disabled||a[i]();e(m)});s(b[i],"mousedown",e)})},height:function(){return this.$.content.offsetHeight},_fitUI:function(){},isMaximize:function(){return X(this.element,"webim-window-maximize")},
isMinimize:function(){return X(this.element,"webim-window-minimize")}});var xa=function(){var a=false,b=function(){a&&a.deactivate();a=false;return true},c=function(){this&&this!=a&&b()&&(a=this)},e=function(){this&&a==this&&(a=false)};s(v,"mousedown",function(g){g=O(g);for(var i;g;)if(g.id==":webim-window"){i=g;break}else g=g.parentNode;if(i)(g=i.window)&&g.activate();else b()});return function(g){if(g.active()){b();a=g}g.bind("activate",c);g.bind("deactivate",e)}}();I("layout",{template:'<div id="webim" class="webim webim-state-ready">                    <div class="webim-preload ui-helper-hidden-accessible">                    <div id="webim-flashlib-c">                    </div>                    </div><div id=":layout" class="webim-layout"><iframe class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><div class="webim-layout-bg ui-state-default ui-toolbar"></div><div class="webim-ui ui-helper-clearfix">                            <div id=":shortcut" class="webim-shortcut">                            </div>                            <div class="webim-layout-r">                            <div id=":panels" class="webim-panels">                                <div class="webim-window-tab-wrap ui-widget webim-panels-next-wrap">                                            <div id=":next" class="webim-window-tab webim-panels-next ui-state-default">                                                    <div id=":nextMsgCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <em class="ui-icon ui-icon-triangle-1-w"></em>                                                    <span id=":nextCount">0</span>                                            </div>                                </div>                                <div id=":tabsWrap" class="webim-panels-tab-wrap">                                        <div id=":tabs" class="webim-panels-tab">                                        </div>                                </div>                                <div class="webim-window-tab-wrap ui-widget webim-panels-prev-wrap">                                            <div id=":prev" class="webim-window-tab webim-panels-prev ui-state-default">                                                    <div id=":prevMsgCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <span id=":prevCount">0</span>                                                    <em class="ui-icon ui-icon-triangle-1-e"></em>                                            </div>                                </div>                                <div class="webim-window-tab-wrap webim-collapse-wrap ui-widget">                                            <div id=":collapse" class="webim-window-tab webim-collapse ui-state-default" title="<%=collapse%>">                                                    <em class="ui-icon ui-icon-circle-arrow-e"></em>                                            </div>                                </div>                                <div class="webim-window-tab-wrap webim-expand-wrap ui-widget">                                            <div id=":expand" class="webim-window-tab webim-expand ui-state-default" title="<%=expand%>">                                                    <em class="ui-icon ui-icon-circle-arrow-w"></em>                                            </div>                                </div>                            </div>                            <div id=":widgets" class="webim-widgets">                            </div>                            </div>            </div></div>                    </div>',
shortcutLength:5,chatAutoPop:true,tpl_shortcut:'<div class="webim-window-tab-wrap ui-widget webim-shortcut-item"><a class="webim-window-tab" href="<%=link%>" target="<%=target%>">                                                    <div class="webim-window-tab-tip">                                                            <strong><%=title%></strong>                                                    </div>                                                    <em class="webim-icon" style="background-image:url(<%=icon%>)"></em>                                            </a>                                            </div>'},
{_init:function(a,b){b=this.options;n(this,{window:y,widgets:{},panels:{},tabWidth:136,maxVisibleTabs:null,animationTime:210,activeTabId:null,tabs:{},tabIds:[],nextCount:0,prevCount:0});b.unscalable&&E(this.$.layout,"webim-layout-unscalable");b.isMinimize&&this.collapse()},changeState:function(a){this.element.className="webim webim-state-"+a},_ready:false,buildUI:function(){var a=this.$;this.maxVisibleTabs=parseInt(((v.compatMode==="CSS1Compat"&&v.documentElement.clientWidth||v.body.clientWidth)-
45-a.shortcut.offsetWidth-a.widgets.offsetWidth-70)/this.tabWidth);this._fitUI();this._ready=true},_updatePrevCount:function(a){var b=this.tabIds,c=this.maxVisibleTabs,e=b.length,g=this.prevCount;if(!(e<=c)){if(a){for(var i=0,m=0;m<e;m++)if(b[m]==a){i=m;break}if(i<=g)g=i;else if(i>=g+c)g=i-c+1}else g=e-c;this.prevCount=g}},_setVisibleTabs:function(a){for(var b=this.prevCount,c=b+this.maxVisibleTabs,e=this.tabs,g=this.tabIds,i=g.length,m=0,l=0,p=0;p<i;p++){var q=e[g[p]];if(p<b||p>=c)if(a)D(q.element);
else{this.activeTabId==g[p]&&q.minimize();var x=q._count();if(p<b){l+=x;q.pos=1}else{m+=x;q.pos=-1}A(q.element)}else{q.pos=0;D(q.element)}}if(!a){this.setNextMsgNum(m);this.setPrevMsgNum(l)}},setNextMsgNum:function(a){Z(this.$.nextMsgCount,a)},setPrevMsgNum:function(a){Z(this.$.prevMsgCount,a)},slideing:false,_slide:function(a){var b=this,c=b.prevCount,e=b.nextCount;if(e>0&&a==-1||c>0&&a==1){b.slideing=true;if(e==1&&a==-1||c==1&&a==1)b.slideing=false;b._slideSetup(false);b._setVisibleTabs(true);if(a==
-1){b.nextCount--;b.prevCount++}else if(a==1){b.nextCount++;b.prevCount--}var g=b.$.tabs,i=parseFloat(g.style.left);c=-1*b.tabWidth*b.nextCount;var m=parseInt(500/13),l=1,p=(c-i)/m,q=setInterval(function(){g.style.left=i+p*l+"px";if(l==m){if(b.slideing)b._slide(a);else{b._fitUI();b._slideReset()}clearInterval(q)}else l++},13)}},_slideUp:function(){this.slideing=false},_slideSetup:function(a){var b=this.$,c=b.tabsWrap;b=b.tabs;if(!this._tabsWidth)this._tabsWidth=b.clientWidth;if(a)this._tabsWidth=
null;c.style.position=a?"":"relative";c.style.overflow=a?"visible":"hidden";c.style.width=a?"":this._tabsWidth+"px";b.style.width=a?"":this.tabWidth*this.tabIds.length+"px";b.style.position=a?"":"relative"},_slideReset:function(){this._slideSetup(true)},_updateCount:function(){var a=this.maxVisibleTabs,b=this.tabIds.length,c=this.prevCount,e=this.nextCount;if(b<=a)c=e=0;else{e=b-a-c;e=e<0?0:e;c=b-a-e}this.prevCount=c;this.nextCount=e},_updateCountUI:function(){var a=this.$,b=this.prevCount,c=this.nextCount;
c<=0?E(a.next,"ui-state-disabled"):w(a.next,"ui-state-disabled");b<=0?E(a.prev,"ui-state-disabled"):w(a.prev,"ui-state-disabled");if(b>0||c>0){a.next.style.display="block";a.prev.style.display="block"}else{A(a.next);A(a.prev)}a.nextCount.innerHTML=c.toString();a.prevCount.innerHTML=b.toString()},_initEvents:function(){var a=this,b=a.$,c=false;s(a.window,"resize",function(){if(c){c=true;a.buildUI()}});s(b.next,"mousedown",function(){a._slide(-1)});s(b.next,"mouseup",function(){a._slideUp()});oa(b.next);
s(b.prev,"mousedown",function(){a._slide(1)});s(b.prev,"mouseup",function(){a._slideUp()});oa(b.prev);s(b.expand,"click",function(){if(!a.isMinimize())return false;a.expand();a.trigger("expand");return false});s(b.collapse,"click",function(){if(a.isMinimize())return false;a.collapse();a.trigger("collapse");return false});ja(b.collapse,"ui-state-hover","ui-state-default");ja(b.expand,"ui-state-hover","ui-state-default")},isMinimize:function(){return X(this.$.layout,"webim-layout-minimize")},collapse:function(){this.isMinimize()||
E(this.$.layout,"webim-layout-minimize")},expand:function(){this.isMinimize()&&w(this.$.layout,"webim-layout-minimize")},_displayUpdate:function(){this._ready&&this.trigger("displayUpdate")},_fitUI:function(){this._updateCount();this.$.tabs.style.left=-1*this.tabWidth*this.nextCount+"px";this._updateCountUI();this._setVisibleTabs();this._displayUpdate()},_stickyWin:null,_widgetStateChange:function(a,b){b!="minimize"&&o(this.widgets,function(c,e){e.window!=a&&e.window.minimize()});this._displayUpdate()},
widget:function(a){return this.widgets[a]},addWidget:function(a,b,c,e){var g=this;b=n(b,{closeable:false,subHeader:a.header});var i=a.element;b=new z.window(null,b);b.html(i);g.$[e?e:"widgets"].insertBefore(b.element,c&&g.widgets[c]?g.widgets[c].window.element:null);a.window=b;b.bind("displayStateChange",function(m){g._widgetStateChange(this,m)});g.widgets[a.name]=a},focusChat:function(a,b){b=ca(a,b);var c=this.tabs[b],e=this.panels[b];c&&c.isMinimize()&&c.restore();e&&e.focus()},chat:function(a,
b){return this.panels[ca(a,b)]},updateChat:function(a,b){b=k(b);for(var c,e=b.length,g,i=0;i<e;i++){c=b[i];(g=this.panels[ca(a,c.id)])&&g.update(c)}},updateAllChat:function(){o(this.panels,function(a,b){b.update()})},_onChatClose:function(a){this.tabIds=t(this.tabIds,function(b){return b!=a});delete this.tabs[a];delete this.panels[a];this._changeActive(a,true);this._fitUI()},_onChatChange:function(a,b){if(b=="minimize"){this._changeActive(a,true);this._displayUpdate()}else{this._changeActive(a);this._fitUI()}},
_changeActive:function(a,b){var c=this.activeTabId;if(b)c==a&&(this.activeTabId=null);else{c&&c!=a&&this.tabs[c].minimize();this.activeTabId=a;this._updatePrevCount(a)}},addChat:function(a,b,c,e){var g=this,i=g.panels,m=b.id;m=ca(a,m);if(!i[m]){a=g.tabs[m]=(new z.window(null,n({isMinimize:g.activeTabId||!g.options.chatAutoPop,tabWidth:g.tabWidth-2,titleVisibleLength:9},e))).bind("close",function(){g._onChatClose(m)}).bind("displayStateChange",function(l){g._onChatChange(m,l)});g.tabIds.push(m);g.$.tabs.insertBefore(a.element,
g.$.tabs.firstChild);i[m]=new z.chat(null,n({window:a,user:g.options.user,info:b},c));!a.isMinimize()&&g._changeActive(m);g._fitUI()}},removeChat:function(a,b){var c=this.tabs[ca(a,b)];c&&c.close()},removeAllChat:function(){o(this.tabs,function(a,b){b.close()})},addShortcut:function(a){var b=this;if(f(a))o(a,function(g,i){b.addShortcut(i)});else if(h(a)){var c=b.$.shortcut,e=b.options.tpl_shortcut;if(!(c.childNodes.length>b.options.shortcutLength+1)){e=F(G(e,{title:u(a.title),icon:a.icon,link:a.link,
target:a.isExtlink?"_blank":""}));ja(e.firstChild,"ui-state-hover");c.appendChild(e)}}},addWindow:function(){new z.window(null,{})},online:function(){},offline:function(){}});I("history",{user:{},info:{},template:'<div class="webim-history">                        <div id=":content" class="webim-history-content">                 </div></div>'},{_init:function(){N.call(this,"init",[null,this.ui()])},clear:function(){this.$.content.innerHTML="";this.trigger("clear")},add:function(a){a=k(a);var b=a.length,
c=[];if(b){for(var e=0;e<b;e++)c.push(this._renderMsg(a[e]));this.$.content.innerHTML+=c.join("");this.trigger("update")}},_renderMsg:function(a){a=n({},a);N.call(this,"render",[null,this.ui({msg:a})]);var b=a.from,c=a.to,e=a.timestamp,g=a.body,i=true,m=this._lastLogItem,l=[],p;p=a.nick;if(m&&m.to==c&&m.from==b&&e-m.timestamp<6E4)i=false;if(i){this._lastLogItem=a;a=new P(e);l.push('<h4><span class="webim-gray">');l.push(a.getDay(true));l.push(" ");l.push(a.getTime());l.push("</span>");l.push(p);l.push('</h4><hr class="webim-line ui-state-default" />')}l.push("<p>");
l.push(g);l.push("</p>");return l.join("")},_renderDateBreak:function(a){var b=this._lastLogItem,c=new Date,e=new Date,g=[];c.setTime(a);b&&e.setTime(b.timestamp);if(!b||c.getDate()!=e.getDate()||c.getMonth()!=e.getMonth()){g.push("<h5>");g.push((new P(a)).getDay(true));g.push("</h5>")}return g.join("")},ui:function(a){return n({element:this.element,$:this.$},a)},plugins:{}});var ya=function(){function a(e,g){return'<a href="'+(g=="www."?"http://"+e:e)+'"'+c+">"+e+"</a>"}function b(e,g){c+=" "+e+
'="'+g+'"'}var c;return function(e,g){c="";g&&h(g)&&o(g,b);return e.replace(/(https?:\/\/|www\.)([^\s<]+)/ig,a)}}();z.history.defaults.parseMsg=true;N.add("history","parseMsg",{render:function(a,b){var c=b.msg.body;c=W(c);c=ya(c,{target:"_blank"});b.msg.body=c}});z.history.defaults.emot=true;N.add("history","emot",{render:function(a,b){b.msg.body=z.emot.parse(b.msg.body)}});I("emot",{template:'<div class="webim-emot ui-widget-content"><%=emots%></div>'},{_init:function(){var a=this,b=a.element;o(b.firstChild.childNodes,
function(c,e){s(e,"click",function(){w(b,"webim-emot-show");a.trigger("select",this.firstChild.getAttribute("alt"))})})},template:function(){var a=this.emots=webim.ui.emot.emots,b=[];b.push('<ul class="ui-helper-clearfix">');o(a,function(c,e){var g=e.src,i=e.t?e.t:e.q[0];b.push('<li><img src="');b.push(g);b.push('" title="');b.push(i);b.push('" alt="');b.push(e.q[0]);b.push('" /></li>')});b.push("</ul>");return G(this.options.template,{emots:b.join("")})},toggle:function(){la(this.element,"webim-emot-show")}});
n(z.emot,{emots:[{t:"smile",src:"smile.png",q:[":)"]},{t:"smile_big",src:"smile-big.png",q:[":d",":-d",":D",":-D"]},{t:"sad",src:"sad.png",q:[":(",":-("]},{t:"wink",src:"wink.png",q:[";)",";-)"]},{t:"tongue",src:"tongue.png",q:[":p",":-p",":P",":-P"]},{t:"shock",src:"shock.png",q:["=-O","=-o"]},{t:"kiss",src:"kiss.png",q:[":-*"]},{t:"glasses_cool",src:"glasses-cool.png",q:["8-)"]},{t:"embarrassed",src:"embarrassed.png",q:[":-["]},{t:"crying",src:"crying.png",q:[":'("]},{t:"thinking",src:"thinking.png",
q:[":-/",":-\\"]},{t:"angel",src:"angel.png",q:["O:-)","o:-)"]},{t:"shut_mouth",src:"shut-mouth.png",q:[":-X",":-x"]},{t:"moneymouth",src:"moneymouth.png",q:[":-$"]},{t:"foot_in_mouth",src:"foot-in-mouth.png",q:[":-!"]},{t:"shout",src:"shout.png",q:[">:o",">:O"]}],init:function(a){var b=webim.ui.emot,c=b._q={};a=n({dir:"webim/static/emot/default"},a);if(a.emots)b.emots=a.emots;var e=a.dir+"/";o(b.emots,function(g,i){if(i&&i.src)i.src=e+i.src;i&&i.q&&o(i.q,function(m,l){c[l]=g})})},parse:function(a){var b=
webim.ui.emot._q,c=webim.ui.emot.emots;b&&o(b,function(e,g){var i=c[g],m=i.src,l=i.t?i.t:i.q[0],p=[];p.push('<img src="');p.push(m);p.push('" title="');p.push(l);p.push('" alt="');p.push(i.q[0]);p.push('" />');e=W(e);e=e.replace(RegExp("(\\"+".$^*\\[]()|+?{}:<>".split("").join("|\\")+")","g"),"\\$1");a=a.replace(RegExp(e,"g"),p.join(""))});return a}});I("chat",{tpl_header:'<div><div id=":user" class="webim-user"> \t\t\t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" src="" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t\t\t<span id=":userStatus" title="" class="webim-user-status">&nbsp;</span> \t\t     </div></div>',
template:'<div class="webim-chat"> \t\t\t\t<div class="webim-chat-notice-wrap"><div id=":notice" class="webim-chat-notice ui-state-highlight"></div></div>                                                 <div id=":content" class="webim-chat-content">                                                                                                                 <div id=":status" class="webim-chat-status webim-gray"></div>                                                 </div>                                                 <div id=":actions" class="webim-chat-actions">                                                         <div id=":toolContent" class="webim-chat-tool-content"></div>                                                        <div id=":tools" class="webim-chat-tools ui-helper-clearfix ui-state-default"></div>                                                        <table class="webim-chat-t" cellSpacing="0">                                                                 <tr>                                                                         <td style="vertical-align:top;">                                                                         <em class="webim-icon webim-icon-chat-edit"></em>                                                                        </td>                                                                         <td style="vertical-align:top;width:100%;">                                                                         <div class="webim-chat-input-wrap">                                                                                <textarea id=":input" class="webim-chat-input webim-gray ui-widget-content"><%=input notice%></textarea>                                                                         </div>                                                                         </td>                                                                 </tr>                                                         </table>                                                 </div>                                         </div>'},
{_init:function(){var a=this.element,b=this.options,c=this.window=b.window,e=this.history=new z.history(null,{user:b.user,info:b.info});this.$.content.insertBefore(e.element,this.$.content.firstChild);this.header=F(G(b.tpl_header));n(this.$,sa(this.header));if(c){c.subHeader(this.header);c.html(a);this._bindWindow()}b.simple&&A(this.header);this.update(b.info);e.add(b.history);N.call(this,"init",[null,this.ui()]);this._adjustContent()},update:function(a){if(a){this.option("info",a);this.history.option("info",
a);this._updateInfo(a)}a=this.options.info.presence=="online";if(this.options.user.presence=="online")a?this.notice(""):this.notice(u("buddy offline notice",{name:this.options.info.nick}));else this.notice(u("user offline notice"));N.call(this,"update",[null,this.ui()])},focus:function(){var a=this.$.input;y.setTimeout(function(){a.focus()},0)},_noticeTime:null,_noticeTxt:"",notice:function(a,b){var c=this,e=c.$.notice,g=c._noticeTime;g&&clearTimeout(g);if(a)if(b){e.innerHTML=a;D(e);setTimeout(function(){if(c._noticeTxt)e.innerHTML=
c._noticeTxt;else A(e,500)},b)}else{c._noticeTxt=a;e.innerHTML=a;D(e)}else{c._noticeTxt=null;A(e)}},_adjustContent:function(){var a=this.$.content;a.scrollTop=a.scrollHeight},_fitUI:function(){this._adjustContent()},_bindWindow:function(){var a=this;a.window.bind("displayStateChange",function(b){if(b!="minimize"){y.setTimeout(function(){a.$.input.focus()},0);a._adjustContent()}})},_inputAutoHeight:function(){var a=this.$.input,b=a[0].scrollTop;if(b>0){var c=a.height();c>32&&c<100&&a.height(c+b)}},
_sendMsg:function(a){var b=this.options,c=b.info;a={type:b.msgType,to:c.id,from:b.user.id,nick:b.user.nick,offline:c.presence!="online",timestamp:(new Date).getTime(),body:a};N.call(this,"send",[null,this.ui({msg:a})]);this.trigger("sendMsg",a)},_inputkeypress:function(a){if(a.keyCode==13)if(a.ctrlKey){this.insert("\n",true);return true}else{var b=O(a),c=b.value;if(j(c)){this._sendMsg(c);b.value="";J(a)}}else this._typing()},_onFocusInput:function(a){var b=this;O(a);(y.getSelection?y.getSelection().toString():
v.selection?v.selection.createRange().text:"")||y.setTimeout(function(){b.$.input.focus()},0)},_initEvents:function(){var a=this,b=a.$,c=u("input notice"),e=b.input;a.history.bind("update",function(){a._adjustContent()}).bind("clear",function(){a.notice(u("clear history notice"),3E3)});s(e,"keyup",function(){U.call(this)});s(e,"click",U);s(e,"select",U);s(e,"focus",function(){w(this,"webim-gray");if(this.value==c)this.value=""});s(e,"blur",function(){if(this.value==""){E(this,"webim-gray");this.value=
c}});s(e,"keypress",function(g){a._inputkeypress(g)});s(b.content,"click",function(g){a._onFocusInput(g)})},_updateInfo:function(a){var b=this.$;b.userPic.setAttribute("href",a.url);b.userPic.firstChild.setAttribute("defaultsrc",a.default_pic_url?a.default_pic_url:"");setTimeout(function(){if(a.pic_url||a.default_pic_url)b.userPic.firstChild.setAttribute("src",a.pic_url||a.default_pic_url)},100);b.userStatus.innerHTML=ea(a.status)||"&nbsp";this.window.title(a.nick,a.show)},insert:function(a,b){var c=
this.$.input;c.focus();if(b){a||(a="");if(c.setSelectionRange){var e=c.value,g=c.selectionStart,i=c.selectionEnd,m=e.substring(0,g);e=e.substring(i);i=a.length;c.value=m+a+e;c.setSelectionRange(g+i,g+i)}else if(v.selection)if(g=c.caretPos){g.text=a;g.collapse();g.select()}else c.value+=a;else c.value+=a}else c.value=a},_statusText:"",sendStatus:function(a){if(!(!a||a==this._statusText||this.options.info.presence=="offline")){this._statusText=a;this.trigger("sendStatus",{to:this.options.info.id,show:a})}},
_checkST:false,_typing:function(){var a=this;a.sendStatus("typing");a._checkST&&clearTimeout(a._checkST);a._checkST=y.setTimeout(function(){a.sendStatus("clear")},6E3)},_setST:null,status:function(a){a=a||"clear";var b=this.$.status,c=this.options.info.nick,e="";e=a=="clear"?"":c+u(a);b.innerHTML=e;this._adjustContent();this._setST&&clearTimeout(this._setST);if(e!="")this._setST=y.setTimeout(function(){b.innerHTML=""},1E4)},destroy:function(){this.window.close()},ui:function(a){return n({self:this,
$:this.$,history:this.history},a)},plugins:{}});z.chat.defaults.emot=true;N.add("chat","emot",{init:function(a,b){var c=b.self,e=new z.emot;e.bind("select",function(i){c.focus();c.insert(i,true)});var g=F(G('<a href="#chat-emot" title="<%=emot%>"><em class="webim-icon webim-icon-emot"></em></a>'));s(g,"click",function(i){J(i);e.toggle()});b.$.toolContent.appendChild(e.element);b.$.tools.appendChild(g)},send:function(){}});z.chat.defaults.clearHistory=true;N.add("chat","clearHistory",{init:function(a,
b){var c=b.self,e=F(G('<a href="#chat-clearHistory" title="<%=clear history%>"><em class="webim-icon webim-icon-clear"></em></a>'));s(e,"click",function(g){J(g);c.trigger("clearHistory",[c.options.info])});b.$.tools.appendChild(e)}});z.chat.defaults.block=true;N.add("chat","block",{init:function(a,b){var c=b.self,e=c.options.info.blocked,g=c.options.info.nick,i=F('<a href="#chat-block" style="display:'+(e?"none":"")+'" title="'+u("block group",{name:g})+'"><em class="webim-icon webim-icon-unblock"></em></a>'),
m=F('<a href="#chat-block" style="display:'+(e?"":"none")+'" title="'+u("unblock group",{name:g})+'"><em class="webim-icon webim-icon-block"></em></a>');s(i,"click",function(l){J(l);A(i);D(m);c.trigger("block",[c.options.info])});s(m,"click",function(l){J(l);A(m);D(i);c.trigger("unblock",[c.options.info])});b.$.tools.appendChild(i);b.$.tools.appendChild(m)}});z.chat.defaults.member=true;n(z.chat.prototype,{addMember:function(a,b,c){var e=this,g=e.memberLi;if(!g[a]){var i=F('<li><a class="'+(c?"ui-state-disabled":
"")+'" href="'+a+'">'+b+"</a></li>");s(i.firstChild,"click",function(m){J(m);c||e.trigger("select",[{id:a,nick:b}])});g[a]=i;e.$.member.appendChild(i);e.$.memberCount.innerHTML=parseInt(e.$.memberCount.innerHTML)+1}},removeMember:function(a){var b=this.memberLi[a];if(b){this.$.member.removeChild(b);delete this.memberLi[a];this.$.memberCount.innerHTML=parseInt(this.$.memberCount.innerHTML)-1}}});N.add("chat","member",{init:function(a,b){var c=b.$;b.self.memberLi={};var e=F(G('<div class="webim-member ui-widget-content ui-corner-left"><iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><h4><%=room member%>(<span id=":memberCount">0</span>)</h4><ul id=":ul"></ul></div>')),
g=sa(e);c.member=g.ul;c.memberCount=g.memberCount;c.content.parentNode.insertBefore(e,c.content)}});T("setting",{init:function(a){var b=this.im.setting,c=this.layout,e=this.setting=new z.setting(null,a);c.addWidget(e,{title:u("setting"),icon:"setting",sticky:false,onlyIcon:true,isMinimize:true});b.bind("update",function(g,i){typeof i!="object"&&e.check_tag(g,i)});e.bind("change",function(g,i){b.set(g,i)})},stop:function(){}});I("setting",{template:'<div id="webim-setting" class="webim-setting">\t\t\t<ul id=":ul"><%=tags%></ul>\t\t   </div>',
tpl_check:'<li id=":<%=name%>"><input type="checkbox" <%=checked%> id="webim-setting-<%=name%>" name="<%=name%>"/><label for="webim-setting-<%=name%>"><%=label%></label></li>'},{_init:function(){},template:function(){var a=this,b=[],c=a.options.data;c&&o(c,function(e,g){g&&typeof g!="boolean"||b.push(a._check_tpl(e,g))});return G(a.options.template,{tags:b.join("")})},_initEvents:function(){var a=this,b=a.options.data,c=a.$;b&&o(b,function(e){c[e]&&a._check_event(c[e])})},_check_tpl:function(a,b){return G(this.options.tpl_check,
{label:u(a),name:a,checked:b?'checked="checked"':""})},_check_event:function(a){var b=this;s(a.firstChild,"click",function(){b._change(this.name,this.checked)})},check_tag:function(a,b){var c=this;if(h(a))o(a,function(i,m){c.check_tag(i,m)});else{var e=c.$,g=e[a];if(!(b&&typeof b!="boolean"))if(g)g.firstChild.checked=b;else{g=e[a]=F(c._check_tpl(a,b));c._check_event(g);e.ul.appendChild(g)}}},_change:function(a,b){this.trigger("change",[a,b])},destroy:function(){}});T("user",{init:function(a){a=a||
{};var b=this.im,c=this.user=new z.user;a.container&&a.container.appendChild(c.element);c.bind("online",function(e){b.online(e)}).bind("offline",function(){b.offline()}).bind("presence",function(e){b.sendPresence(e)});c.update(b.data.user)},ready:function(){},go:function(){this.user.update(this.im.data.user)},stop:function(){this.user.show("unavailable")}});I("user",{template:'<div>  \t\t<div id=":user" class="webim-user"> \t\t\t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t\t\t\t<div class="webim-user-show"><h4><a  id=":userShowTrigger" href="#show"><strong id=":userNick"></strong><span id=":userShow"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></span><em class="ui-icon ui-icon-triangle-1-s"><%=show_status_list%></em></a></h4>\t\t\t\t\t<p id=":userShowList" class="ui-state-active ui-corner-all" style="display: none;">\t\t\t\t\t\t<a href="#available" class="webim-user-show-available"><em class="webim-icon webim-icon-available"><%=available%></em><%=available%></a>\t\t\t\t\t\t<a href="#dnd" class="webim-user-show-dnd"><em class="webim-icon webim-icon-dnd"><%=dnd%></em><%=dnd%></a>\t\t\t\t\t\t<a href="#away" class="webim-user-show-away"><em class="webim-icon webim-icon-away"><%=away%></em><%=away%></a>\t\t\t\t\t\t<a href="#invisible" class="webim-user-show-invisible"><em class="webim-icon webim-icon-invisible"><%=invisible%></em><%=invisible%></a>\t\t\t\t\t\t<a href="#unavailable" class="webim-user-show-unavailable"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></a>\t\t\t\t\t</p>\t\t\t\t</div> \t\t\t\t\t<span id=":userStatus" title="" class="webim-user-status"></span> \t\t\t\t\t\t</div> \t\t\t\t\t\t\t</div>'},
{_init:function(){},_initEvents:function(){var a=this,b=a.$,c=b.userShowList;s(b.userShowTrigger,"click",function(e){c.style.display=="block"?A(c):D(c);J(e)});o(ia(c.firstChild),function(e,g){s(g,"click",function(i){a._set(this.href.split("#")[1]);A(c);J(i)})})},update:function(a){var b=a.show||"unavailable",c=this.$;this.options.info=a;c.userStatus.innerHTML=ea(a.status)||"&nbsp;";c.userNick.innerHTML=a.nick||"";c.userPic.setAttribute("href",a.url);c.userPic.firstChild.setAttribute("defaultsrc",
a.default_pic_url?a.default_pic_url:"");setTimeout(function(){if(a.pic_url||a.default_pic_url)c.userPic.firstChild.setAttribute("src",a.pic_url||a.default_pic_url)},100);this.show(b)},show:function(a){var b=u(a);this.$.userShow.innerHTML='<em class="webim-icon webim-icon-'+a+'">'+b+"</em>"+b},_set:function(a){var b=this.options.info;this.show(a);if(b){if(b.show!=a)if(a=="unavailable")this.trigger("offline",[]);else b.show=="unavailable"?this.trigger("online",[{show:a}]):this.trigger("presence",[{show:a,
status:b.status}])}else a!="unavailable"&&this.trigger("online",[{show:a}])},destroy:function(){}});T("buddy",{init:function(a){a=a||{};var b=this,c=b.im,e=c.buddy,g=b.layout,i=b.buddy=new z.buddy(null,n({title:u("buddy")},a));g.addWidget(i,n({title:u("buddy"),icon:"buddy",sticky:c.setting.get("buddy_sticky"),className:"webim-buddy-window",isMinimize:!c.status.get("b"),titleVisibleLength:19},a.windowOptions));if(!a.disable_user){b.addApp("user");i.window.subHeader(b.user.element)}c.setting.bind("update",
function(q,x){q=="buddy_sticky"&&i.window.option("sticky",x)});i.bind("select",function(q){b.addChat("buddy",q.id);b.layout.focusChat("buddy",q.id)}).bind("online",function(){c.online()});i.window.bind("displayStateChange",function(q){if(q!="minimize"){e.option("active",true);c.status.set("b",1);e.complete()}else{c.status.set("b",0);e.option("active",false)}});var m=function(q){return h(q)?q.id:q},l=function(q){return q.show!="invisible"&&q.presence=="online"},p=function(q){return q.show=="invisible"};
e.bind("online",function(q){i.add(t(q,l))});e.bind("offline",function(q){i.remove(R(q,m))});e.bind("update",function(q){i.add(t(q,l));i.update(t(q,l));i.remove(R(t(q,p),m))});i.offline()},ready:function(){this.buddy.online()},go:function(){this.buddy.titleCount()},stop:function(a){var b=this.buddy;b.offline();a&&b.notice(a)}});I("buddy",{template:'<div id="webim-buddy" class="webim-buddy">\t\t<div id=":search" class="webim-buddy-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-buddy-content">\t\t\t\t<div id=":empty" class="webim-buddy-empty"><%=empty buddy%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',
tpl_group:'<li><h4><%=title%>(<%=count%>)</h4><hr class="webim-line ui-state-default" /><ul></ul></li>',tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><em class="webim-icon webim-icon-<%=show%>" title="<%=human_show%>"><%=show%></em><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong><span><%=status%></span></a></li>'},{_init:function(){var a=
this.options;this.groups={};this.li={};this.li_group={};this.size=0;a.disable_group&&E(this.element,"webim-buddy-hidegroup");a.simple&&E(this.element,"webim-buddy-simple")},_initEvents:function(){var a=this,b=a.$,c=b.search,e=b.searchInput,g=u("search buddy");s(c.firstChild,"click",function(){e.focus()});e.value=g;s(e,"focus",function(){E(c,"ui-state-active");if(this.value==g)this.value=""});s(e,"blur",function(){w(c,"ui-state-active");if(this.value=="")this.value=g});s(e,"keyup",function(){var i=
this.value;o(a.li,function(m,l){i&&(l.text||l.innerHTML.replace(/<[^>]*>/g,"")).indexOf(i)==-1?A(l):D(l)})})},titleCount:function(){var a=this.size,b=this.window,c=this.$.empty;b&&b.title(this.options.title+"("+(a?a:"0")+")");a?A(c):D(c);a>8?this.scroll(true):this.scroll(false)},scroll:function(a){la(this.element,"webim-buddy-scroll",a)},_time:null,_titleBuddyOnline:function(a){var b=this;a||(a="");b._time&&clearTimeout(b._time);b._time=setTimeout(function(){b.titleCount()},5E3)},_title:function(a){var b=
this.window;b&&b.title(this.options.title+"["+u(a)+"]")},notice:function(a,b){switch(a){case "buddyOnline":this._titleBuddyOnline(b);break;default:this._title(a)}},online:function(){var a=this.$;this.notice("connect");D(a.empty)},offline:function(){var a=this.$;this.notice("offline");D(a.empty);this.scroll(false);this.removeAll()},_updateInfo:function(a,b){a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;var c=b.show?b.show:"available";a.className="webim-icon webim-icon-"+c;a.setAttribute("title",
u(c));a=a.nextSibling;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");if(b.pic_url||b.default_pic_url)a.setAttribute("src",b.pic_url||b.default_pic_url);a=a.nextSibling;a.innerHTML=b.nick;a=a.nextSibling;a.innerHTML=ea(b.status)||"&nbsp;";return a},_addOne:function(a,b){var c=this,e=c.li,g=a.id,i=c.$.ul;if(!e[g]){c.size++;if(!a.default_pic_url)a.default_pic_url="";a.status=ea(a.status)||"&nbsp;";a.show=a.show||"available";a.human_show=u(a.show);a.pic_url=a.pic_url||"";e=e[g]=F(G(c.options.tpl_li,
a));s(e.firstChild,"click",function(p){J(p);c.trigger("select",[a]);this.blur()});var m=c.groups,l=u(a.group||"friend");m=m[l];if(!m){m=F(G(c.options.tpl_group));A(m);if(l==u("stranger"))b=true;b?i.appendChild(m):i.insertBefore(m,i.firstChild);m={name:l,el:m,count:0,title:m.firstChild,li:m.lastChild};c.groups[l]=m}m.count==0&&D(m.el);c.li_group[g]=m;m.li.appendChild(e);m.count++;m.title.innerHTML=l+"("+m.count+")"}},_updateOne:function(a){var b=this.li,c=a.id;b[c]&&this._updateInfo(b[c],a)},update:function(a){a=
k(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a,b){a=k(a);for(var c=0;c<a.length;c++)this._addOne(a[c],b);this.titleCount()},removeAll:function(){var a=[],b=this.li;for(var c in b)a.push(c);this.remove(a);this.titleCount()},remove:function(a){var b,c,e=this.li,g,i=this.li_group;a=na(a);for(var m=0;m<a.length;m++){b=a[m];if(c=e[b]){this.size--;if(g=i[b]){g.count--;g.count==0&&A(g.el);g.title.innerHTML=g.name+"("+g.count+")"}S(c);delete e[b]}}this.titleCount()},select:function(a){(a=
this.li[a])&&a.firstChild.click();return a},destroy:function(){}});T("room",{init:function(){function a(l){var p=l.nick;l=n({},l,{group:"group",nick:p+"("+(parseInt(l.count)+"/"+parseInt(l.all_count))+")"});i.updateChat(l);l.blocked&&(l.nick=p+"("+u("blocked")+")");m.li[l.id]?m.update(l):m.add(l)}var b=this,c=b.im,e=c.room,g=c.setting,i=b.layout,m=b.room=(new webim.ui.room(null)).bind("select",function(l){b.addChat("room",l.id);b.layout.focusChat("room",l.id)});i.addWidget(m,{title:u("room"),icon:"room",
sticky:c.setting.get("buddy_sticky"),onlyIcon:true,isMinimize:true},"notification");c.setting.bind("update",function(l,p){l=="buddy_sticky"&&m.window.option("sticky",p)});e.bind("join",function(l){a(l)}).bind("leave",function(){}).bind("block",function(l,p){g.set("blocked_rooms",p);a(e.get(l));e.leave(l)}).bind("unblock",function(l,p){g.set("blocked_rooms",p);a(e.get(l));e.join(l)}).bind("addMember",function(l){a(e.get(l))}).bind("removeMember",function(l){a(e.get(l))})},ready:function(){},go:function(){},
stop:function(){}});I("room",{template:'<div id="webim-room" class="webim-room">\t\t<div id=":search" class="webim-room-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-room-content">\t\t\t\t<div id=":empty" class="webim-room-empty"><%=empty room%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong></a></li>'},
{_init:function(){this.size=0;this.li={};this._count=0;D(this.$.empty)},_initEvents:function(){var a=this,b=a.$,c=b.search,e=b.searchInput,g=u("search room");s(c.firstChild,"click",function(){e.focus()});e.value=g;s(e,"focus",function(){E(c,"ui-state-active");if(this.value==g)this.value=""});s(e,"blur",function(){w(c,"ui-state-active");if(this.value=="")this.value=g});s(e,"keyup",function(){var i=this.value;o(a.li,function(m,l){i&&(l.text||l.innerHTML.replace(/<[^>]*>/g,"")).indexOf(i)==-1?A(l):D(l)})})},
scroll:function(a){la(this.element,"webim-room-scroll",a)},_updateInfo:function(a,b){a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");a.setAttribute("src",b.pic_url);a=a.nextSibling;a.innerHTML=b.nick;return a},_addOne:function(a){var b=this,c=b.li,e=a.id,g=b.$.ul;b.size++;if(!c[e]){if(!a.default_pic_url)a.default_pic_url="";c=c[e]=F(G(b.options.tpl_li,a));s(c.firstChild,"click",function(i){J(i);b.trigger("select",[a]);
this.blur()});g.appendChild(c)}},_updateOne:function(a){var b=this.li,c=a.id;b[c]&&this._updateInfo(b[c],a)},update:function(a){a=k(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a){A(this.$.empty);a=k(a);for(var b=0;b<a.length;b++)this._addOne(a[b]);this.size>8&&this.scroll(true)},removeAll:function(){var a=[],b=this.li;for(var c in b)a.push(c);this.remove(a)},remove:function(a){var b,c,e=this.li;a=na(a);for(var g=0;g<a.length;g++){b=a[g];if(c=e[b]){S(c);delete e[b]}}},select:function(a){(a=
this.li[a])&&a.firstChild.click();return a},destroy:function(){}});T("menu",{init:function(a){var b=this.layout;a=this.menu=new z.menu(null,a);b.addWidget(a,{title:u("menu"),icon:"home",sticky:false,onlyIcon:false,isMinimize:true},null,"shortcut")}});I("menu",{template:'<div id="webim-menu" class="webim-menu">\t\t<ul id=":ul"><%=list%></ul>\t\t\t<div id=":empty" class="webim-menu-empty"><%=empty menu%></div>\t\t\t\t</div>',tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><img src="<%=icon%>"/><span><%=title%></span></a></li>'},
{_init:function(){var a=this.options;a.data&&a.data.length&&A(this.$.empty)},template:function(){var a=this,b=[],c=a.options.data;c&&o(c,function(e,g){b.push(a._li_tpl(g))});return G(a.options.template,{list:b.join("")})},_li_tpl:function(a){return G(this.options.tpl_li,{title:u(a.title),icon:a.icon,link:a.link,target:a.isExtlink?"_blank":""})},_fitUI:function(){var a=this.element;if(a.clientHeight>300)a.style.height="300px"},add:function(a){var b=this;if(f(a))o(a,function(e,g){b.add(g)});else{var c=
b.$;A(c.empty);c.ul.appendChild(F(b._li_tpl(a)))}},destroy:function(){}});T("chatlink",{init:function(a){var b=this,c=b.im,e=b.chatlink=(new webim.ui.chatlink(null,a)).bind("select",function(m){b.addChat("buddy",m);b.layout.focusChat("buddy",m)}),g=function(m){return m.show!="invisible"&&m.presence=="online"},i=function(m){return m.show=="invisible"};c.buddy.bind("online",function(m){e.add(t(m,g))}).bind("update",function(m){e.add(t(m,g));e.remove(t(m,i))}).bind("offline",function(m){e.remove(m)})},
ready:function(a){a.stranger_ids=this.chatlink.idsArray()},go:function(){this.chatlink.remove(this.im.data.user)},stop:function(){this.chatlink.removeAll()}});I("chatlink",{link_href:[/space\.php\?uid=(\d+)$/i,/space\-(\d+)\.html$/i,/space\-uid\-(\d+)\.html$/i,/\?mod=space&uid=(\d+)$/,/\?(\d+)$/],space_href:[/space\.php\?uid=(\d+)$/i,/space\-(\d+)\.html$/i,/space\-uid\-(\d+)\.html$/i,/\?mod=space&uid=(\d+)/,/\?(\d+)$/],space_class:/spacemenu_list|line_list|xl\sxl2\scl/i,space_id:/profile_act/i,off_link_class:null,
link_wrap:null,space_wrap:null},{_init:function(){function a(B,Q){if(!B)return false;for(var ha=Q.length,pa=0;pa<ha;pa++){var wa=Q[pa].exec(B);if(wa&&wa[1])return wa[1]}return false}var b=this.list={},c=this.options,e=this.anthors={},g=c.link_href,i=c.space_href,m=c.space_id,l=c.off_link_class,p=c.space_class,q=c.space_wrap||v;(c=(c.link_wrap||v).getElementsByTagName("a"))&&o(c,function(B,Q){var ha=a(Q.href,g),pa=Q.innerHTML;if(ha&&ia(Q.firstChild).length==0&&pa&&(!Q.className||!l||!l.test(Q.className))){e[ha]?
e[ha].push(Q):e[ha]=[Q];b[ha]={id:ha,name:pa}}});if(i=a(y.location.href,i)){b[i]=n(b[i],{id:i});q=q.getElementsByTagName("*");c=q.length;for(var x,H,K,L=0;L<c;L++){x=q[L];H=x.className;K=x.id;if(p&&p.test(H)||m&&m.test(K)){x=ia(x.firstChild);if(x.length){x=x[x.length-1];e[i]?e[i].push(x):e[i]=[x]}break}}}},_temp:function(a){var b=this;a=F(G('<a id="<%=id%>" href="#chat" title="<%=title%>" class="webim-chatlink"><%=text%></a>',a));s(a,"click",function(c){b.trigger("select",this.id);ua(c);J(c)});return a},
idsArray:function(){var a=[];o(this.list,function(b){a.push(b)});return a},add:function(a){var b=this.list,c=this.anthors,e=a.length,g,i,m,l,p;for(g=0;g<e;g++){i=a[g];if(i.id&&(m=i.uid)&&(l=b[m])){p=c[m];if(!l.elements&&p){l.elements=[];for(var q=0;q<p.length;q++)if(p[q].tagName.toLowerCase()=="li"){l.elements[q]=v.createElement("li");l.elements[q].appendChild(this._temp({id:i.id,title:"",text:u("chat with me")}))}else l.elements[q]=this._temp({id:i.id,title:u("chat with",{name:l.name}),text:""})}p&&
o(p,function(x,H){H.parentNode.insertBefore(l.elements[x],H.nextSibling)})}}},remove:function(a){var b=this.list,c=a.length,e,g,i,m;for(e=0;e<c;e++){g=a[e];if(g.id&&(i=g.uid)&&(m=b[i]))m.elements&&o(m.elements,function(l,p){S(p)})}},removeAll:function(){o(this.list,function(a,b){b.elements&&o(b.elements,function(c,e){S(e)})})}});da("notification",{url:"webim/notifications"},{grep:function(a){return a&&a.text},handle:function(a){a=t(k(a),this.grep);a.length&&this.trigger("data",[a])},load:function(){r({url:this.options.url,
cache:false,dataType:"json",context:this,success:this.handle})}});T("notification",{init:function(a){var b=this.im,c=this.layout,e=this.notification=new z.notification(null,a),g=b.notification=new webim.notification;c.addWidget(e,{title:u("notification"),icon:"notification",sticky:false,onlyIcon:true,isMinimize:true});g.bind("data",function(i){e.window.notifyUser("information","+"+i.length);e.add(i)});setTimeout(function(){g.load()},2E3)}});I("notification",{template:'<div id="webim-notification" class="webim-notification">\t\t<ul id=":ul"><%=list%></ul>\t\t\t<div id=":empty" class="webim-notification-empty"><%=empty notification%></div>\t\t\t\t</div>',
tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><%=text%></a></li>'},{_init:function(){var a=this.options;a.data&&a.data.length&&A(this.$.empty)},template:function(){var a=this,b=[],c=a.options.data;c&&o(c,function(e,g){b.push(a._li_tpl(g))});return G(a.options.template,{list:b.join("")})},_li_tpl:function(a){return G(this.options.tpl_li,{text:a.text,link:a.link,target:a.isExtlink?"_blank":""})},_fitUI:function(){var a=this.element;if(a.clientHeight>300)a.style.height="300px"},add:function(a){var b=
this;if(f(a))o(a,function(e,g){b.add(g)});else{var c=b.$;A(c.empty);c.ul.appendChild(F(b._li_tpl(a)))}},destroy:function(){}})})(window,document);

(function(w,v,aa){function oa(){return(new Date).getTime()}function V(c){return x.call(c)==="[object Function]"}function ba(c){return x.call(c)==="[object Array]"}function ka(c){return c&&x.call(c)==="[object Object]"}function Y(c){return(c||"").replace(/^\s+|\s+$/g,"")}function D(c,g){var f=false;if(ka(g)){c=c||{};for(var i in g){var k=g[i];if(c[i]!=k){f=f||{};f[i]=k}}}return f}function E(c){var g=[];if(c!=null){var f=c.length;if(f==null||typeof c==="string"||V(c)||c.setInterval)g[0]=c;else for(;f;)g[--f]=
c[f]}return g}function y(){var c=arguments[0]||{},g=1,f=arguments.length,i=false,k;if(typeof c==="boolean"){i=c;c=arguments[1]||{};g=2}if(typeof c!=="object"&&!V(c))c={};for(;g<f;g++)if((k=arguments[g])!=null)for(var o in k){var q=c[o],r=k[o];if(c!==r)if(i&&r&&typeof r==="object"&&!r.nodeType)c[o]=y(i,q||(r.length!=null?[]:{}),r);else if(r!==aa)c[o]=r}return c}function L(c,g,f){var i,k=0,o=c.length,q=o===aa||V(c);if(f)if(q)for(i in c){if(g.apply(c[i],f)===false)break}else for(;k<o;){if(g.apply(c[k++],
f)===false)break}else if(q)for(i in c){if(g.call(c[i],i,c[i])===false)break}else for(f=c[0];k<o&&g.call(f,k,f)!==false;f=c[++k]);return c}function ha(c,g,f){for(var i=[],k=0,o=c.length;k<o;k++)!f!==!g(c[k],k)&&i.push(c[k]);return i}function F(c,g){for(var f=[],i,k=0,o=c.length;k<o;k++){i=g(c[k],k);if(i!=null)f[f.length]=i}return f.concat.apply([],f)}function z(c){var g=[];if(typeof c=="object"){for(var f in c)g[g.length]=encodeURIComponent(f)+"="+encodeURIComponent(c[f]);return g.join("&").replace(ia,
"+")}return c}function C(c){c=y(true,c,y(true,{},pa,c));var g,f,i=c.context||w,k=c.type.toUpperCase();if(c.data&&c.processData&&typeof c.data!=="string")c.data=z(c.data);if(c.cache===false&&k==="GET"){var o=oa(),q=c.url.replace(ea,"$1_="+o+"$2");c.url=q+(q===c.url?(K.test(c.url)?"&":"?")+"_="+o:"")}if(c.data&&k==="GET")c.url+=(K.test(c.url)?"&":"?")+c.data;var r=false,p=c.xhr();c.username?p.open(k,c.url,c.async,c.username,c.password):p.open(k,c.url,c.async);try{c.data&&p.setRequestHeader("Content-Type",
c.contentType);if(c.ifModified){la[c.url]&&p.setRequestHeader("If-Modified-Since",la[c.url]);Z[c.url]&&p.setRequestHeader("If-None-Match",Z[c.url])}p.setRequestHeader("X-Requested-With","XMLHttpRequest");p.setRequestHeader("Accept",c.dataType&&c.accepts[c.dataType]?c.accepts[c.dataType]+", */*":c.accepts._default)}catch(W){}if(c.beforeSend&&c.beforeSend.call(i,p,c)===false){p.abort();return false}var B=function(ca){if(!p||p.readyState===0){if(O){clearInterval(O);O=null}}else if(!r&&p&&(p.readyState===
4||ca==="timeout")){r=true;if(O){clearInterval(O);O=null}var A;if(ca==="timeout")A="timeout";else{a:{try{A=!p.status&&location.protocol==="file:"||p.status>=200&&p.status<300||p.status===304||p.status===1223||p.status===0;break a}catch(ta){}A=false}if(A){if(A=c.ifModified){A=p;var S=c.url,G=A.getResponseHeader("Last-Modified"),M=A.getResponseHeader("Etag");if(G)la[S]=G;if(M)Z[S]=M;A=A.status===304||A.status===0}A=A?"notmodified":"success"}else A="error";A=A}g=A;if(g==="success")try{A=p;var ma=c.dataType;
S=c;var qa=A.getResponseHeader("content-type"),ra=ma==="xml"||!ma&&qa&&qa.indexOf("xml")>=0,a=ra?A.responseXML:A.responseText;if(ra&&a.documentElement.nodeName==="parsererror")throw"parsererror";if(S&&S.dataFilter)a=S.dataFilter(a,ma);if(typeof a==="string")if(ma==="json")a=typeof P==="object"&&P.parse?P.parse(a):(new Function("return "+a))();f=a}catch(b){g="parsererror"}if(g==="success"||g==="notmodified")c.success&&c.success.call(i,f,g);else if(c.error)c.error.call(c.context||w,p,g,void 0);c.complete&&
c.complete.call(i,p,g);ca&&p.abort();if(c.async)p=null}};if(c.async){var O=setInterval(B,13);c.timeout>0&&setTimeout(function(){p&&!r&&B("timeout")},c.timeout)}try{p.send(k==="POST"||k==="PUT"?c.data:null)}catch(T){if(c.error)c.error.call(c.context||w,p,null,T)}c.async||B();return p}function s(){}function Q(c){function g(){r=true;w[k]=aa;try{delete w[k]}catch(p){}q.onload=q.onreadystatechange=null;o&&q.parentNode&&o.removeChild(q)}c=y({},c);var f=""+z(c.data),i=c.context||w,k="jsonp"+H++,o=v.getElementsByTagName("head")[0]||
v.documentElement,q=v.createElement("script");f=(f?f+"&":"")+(c.jsonp||"callback")+"="+k;c.url+=(K.test(c.url)?"&":"?")+f;q.src=c.url;if(c.scriptCharset)q.charset=c.scriptCharset;var r=false;w[k]=function(p){c.success&&c.success.call(i,p,"success");g()};q.onload=q.onreadystatechange=function(){if(!r&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){c.error&&c.error.call(i,"error");g()}};c.timeout>0&&setTimeout(function(){if(!r){c.error&&c.error.call(i,"timeout");g();w[k]=
s}},c.timeout);o.insertBefore(q,o.firstChild);return aa}function ja(c,g){this._setting();this.options={jsonp:false,server:null,ticket:null,domain:null,timeout:4E4,url:{send:null}};y(this.options,g)}function na(c,g,f){if(typeof g!="undefined"){f=f||{};if(g===null){g="";f=y({},f);f.expires=-1}var i="";if(f.expires&&(typeof f.expires=="number"||f.expires.toUTCString)){if(typeof f.expires=="number"){i=new Date;i.setTime(i.getTime()+f.expires*24*60*60*1E3)}else i=f.expires;i="; expires="+i.toUTCString()}var k=
f.path?"; path="+f.path:"",o=f.domain?"; domain="+f.domain:"";f=f.secure?"; secure":"";v.cookie=[c,"=",encodeURIComponent(g),i,k,o,f].join("")}else{g=null;if(v.cookie&&v.cookie!=""){f=v.cookie.split(";");for(i=0;i<f.length;i++){k=Y(f[i]);if(k.substring(0,c.length+1)==c+"="){g=decodeURIComponent(k.substring(c.length+1));break}}}return g}}function da(c,g){if($){var f=new Date,i=["[",f.getHours(),":",f.getMinutes(),":",f.getSeconds(),"-",f.getMilliseconds(),"]"].join("");f=i+g+P.encode(c);w.console&&
w.console.log(i,g,c);i=v.getElementById("webim-log")||v.body;w.air&&w.air.trace(f);if(i){var k=v.createElement("P");k.innerHTML=f;i.appendChild(k)}}}function U(c,g){this.options=y({},U.defaults,g);this._init(c,g)}function R(c){return c&&c.split?c.split(","):ba(c)?c:parseInt(c)?[parseInt(c)]:[]}function t(c,g,f){function i(k,o){this.data=k;this.options=y({},i.defaults,o);V(this._init)&&this._init()}i.defaults=g;y(i.prototype,fa,f);U[c]=i}var x=Object.prototype.toString,fa={option:function(c,g){var f=
c;this.options=this.options||{};if(typeof c=="string"){if(g===aa)return this.options[c];f={};f[c]=g}y(this.options,f);return this},bind:function(c,g){var f=this._events=this._events||{};if(V(g)){f[c]=f[c]||[];f[c].push(g)}return this},trigger:function(c,g){var f=(this._events=this._events||{})[c];if(!f)return this;g=ba(g)?g:E(g);for(var i=0,k=f.length;i<k;i++)f[i].apply(this,g);return this},unbind:function(c,g){var f=this._events=this._events||{};if(!f[c])return this;if(V(g)){f=f[c];for(var i=f.length;i--;)if(f[i]===
g||f[i]===g._proxy)f.splice(i,1)}else delete f[c];return this},one:function(c,g){if(!V(g))return this;var f=this,i=g._proxy=fun._proxy||function(){f.unbind(c,i);return g.apply(this,arguments)};f.bind(c,i)}},H=oa(),K=/\?/,ea=/(\?|&)_=.*?(&|$)/,ia=/%20/g,pa={url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return w.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest},accepts:{xml:"application/xml, text/xml",
html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}},la={},Z={},P=function(){function c(i){return f[i]||"\\u00"+Math.floor(i.charCodeAt()/16).toString(16)+(i.charCodeAt()%16).toString(16)}function g(i){switch(Object.prototype.toString.call(i)){case "[object String]":return'"'+i.replace(/[\x00-\x1f\\"]/g,c)+'"';case "[object Array]":for(var k=[],o=i.length,q=0;q<o;q++)k.push(g(i[q]));return"["+k.join(",")+"]";
case "[object Object]":k=[];for(o in i)(q=g(i[o]))&&k.push(g(o)+":"+q);return"{"+k+"}";case "[object Number]":case "[object Boolean]":return String(i);case false:return"null"}return null}var f={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return{encode:g,decode:function(i){i=i.toString();if(!i||!i.length)return null;return(new Function("return "+i))()}}}();y(ja.prototype,fa,{_setting:function(){this._onPolling=this._connecting=this.connected=false;this._pollTimer=
null;this._failTimes=this._pollingTimes=0},connect:function(c){var g=this;y(g.options,c);if(g._connecting)return g;g._connecting=true;c=g.options;g._onPolling||w.setTimeout(function(){g._startPolling()},300);return g},close:function(){this._pollTimer&&clearTimeout(this._pollTimer);this._setting();return this},_onConnect:function(){this.connected=true;this.trigger("connect","success")},_onClose:function(c){this._setting();this.trigger("close",[c])},_onData:function(c){this.trigger("data",c)},_onError:function(c){this._setting();
this.trigger("error",c)},_startPolling:function(){var c=this.options;this._onPolling=true;this._pollingTimes++;var g={url:c.server,data:{domain:c.domain,ticket:c.ticket},dataType:"json",timeout:c.timeout,cache:false,context:this,success:this._onPollSuccess,error:this._onPollError};if(c.jsonp){y(g,{timeout:c.timeout,dataType:"jsonp",jsonp:"callback"});Q(g)}else C(g)},_onPollSuccess:function(c){var g=this;g._onPolling=false;if(g._connecting)if(!c||!c.status)return g._onError("error data");else{g._pollingTimes==
1&&g._onConnect();g._onData(c);g._failTimes=0;g._pollTimer=w.setTimeout(function(){g._startPolling()},200)}},_onPollError:function(c){var g=this;g._onPolling=false;if(g._connecting){g._failTimes++;if(g._pollingTimes==1)g._onError("can not connect.");else if(g._failTimes>1)g._onClose(c);else g._pollTimer=w.setTimeout(function(){g._startPolling()},200)}}});var $=true;da.enable=function(){$=true};da.disable=function(){$=false};y(U.prototype,fa,{_init:function(){this.data={user:{}};this.status=new U.status;
this.setting=new U.setting;this.buddy=new U.buddy(null,{loadDelay:!this.status.get("b")});this.room=new U.room;this.history=new U.history;this.connection=new ja(null,{jsonp:true});this._initEvents()},_ready:function(c){var g=this;g._unloadFun=w.onbeforeunload;w.onbeforeunload=function(){g._refresh()};g.trigger("ready",[c])},_go:function(){var c=this.data,g=this.history,f=this.buddy,i=this.room;g.option("userInfo",c.user);var k=[],o=[];L(c.buddies,function(r,p){p.need_reload?k.push(p.id):o.push(p);
g.init("unicast",p.id,p.history)});f.online(k);f.handle(c.buddies);L(c.rooms,function(r,p){g.init("multicast",p.id,p.history)});f=this.setting.get("blocked_rooms");var q=c.rooms;ba(f)&&q&&L(f,function(r,p){q[p]&&(q[p].blocked=true)});i.handle(q);i.options.ticket=c.connection.ticket;if((i=c.new_messages)&&i.length){L(i,function(r,p){p["new"]=true});this.trigger("message",[i])}this.trigger("go",[c]);this.connection.connect(c.connection)},_stop:function(c){w.onbeforeunload=this._unloadFun;this.data.user.presence=
"offline";this.data.user.show="unavailable";this.buddy.clear();this.trigger("stop",c)},autoOnline:function(){return!this.status.get("o")},_initEvents:function(){function c(q){return q.type=="offline"}function g(q){return q.type=="online"}function f(q){return q.from}var i=this,k=i.history,o=i.buddy;i.connection.bind("connect",function(){}).bind("data",function(q){i.handle(q)}).bind("error",function(){i._stop("connect error")}).bind("close",function(){i._stop("disconnect")});i.bind("message",function(q){for(var r=
[],p=q.length,W=i.data.user.id,B,O,T,ca=0;ca<p;ca++){B=q[ca];T=B.type;O=T=="unicast"?B.to==W?B.from:B.to:B.to;B.id=O;T=="unicast"&&!B["new"]&&r.push(O)}r.length&&o.online(r);k.handle(q)});i.bind("presence",function(q){offline=ha(q,c);online=ha(q,g);o.online(F(online,f));o.offline(F(offline,f))})},handle:function(c){c.messages&&c.messages.length&&this.trigger("message",[c.messages]);c.presences&&c.presences.length&&this.trigger("presence",[c.presences]);c.statuses&&c.statuses.length&&this.trigger("status",
[c.statuses])},sendMsg:function(c){c.ticket=this.data.connection.ticket;C({type:"post",url:this.options.urls.message,cache:false,data:c})},sendStatus:function(c){c.ticket=this.data.connection.ticket;C({type:"post",url:this.options.urls.status,cache:false,data:c})},sendPresence:function(c){c.ticket=this.data.connection.ticket;this.status.set("s",c.show);C({type:"post",url:this.options.urls.presence,cache:false,data:c})},online:function(c){var g=this,f=g.status,i=[],k=[],o=f.get("tabs"),q=f.get("tabIds");
q&&q.length&&o&&L(o,function(r){r[0]=="b"&&i.push(r.slice(2));r[0]=="r"&&k.push(r.slice(2))});c=y({buddy_ids:i.join(","),room_ids:k.join(","),show:f.get("s")||"available"},c);g._ready(c);f.set("o",false);f.set("s",c.show);C({type:"post",dataType:"json",data:c,url:g.options.urls.online,success:function(r){if(!r||!r.user||!r.connection)g._stop("online error");else{r.user=y(g.data.user,r.user,{presence:"online"});g.data=r;g._go()}},error:function(){g._stop("online error")}})},offline:function(){var c=
this.data;this.status.set("o",true);this.connection.close();this._stop("offline");C({type:"post",url:this.options.urls.offline,type:"post",cache:false,data:{status:"offline",ticket:c.connection.ticket}})},_refresh:function(){var c=this.data;!c||!c.connection||!c.connection.ticket||C({type:"post",url:this.options.urls.refresh,type:"post",cache:false,data:{ticket:c.connection.ticket}})}});w.webim=U;y(U,{version:"1.0.0pre",defaults:{urls:{online:"webim/online",offline:"webim/offline",message:"webim/message",
presence:"webim/presence",refresh:"webim/refresh",status:"webim/status"}},log:da,idsArray:R,now:oa,isFunction:V,isArray:ba,isObject:ka,trim:Y,makeArray:E,extend:y,each:L,inArray:function(c,g){for(var f=0,i=g.length;f<i;f++)if(g[f]===c)return f;return-1},grep:ha,map:F,JSON:P,ajax:C,comet:ja,model:t,objectExtend:fa});t("setting",{url:"/webim/setting",data:{play_sound:true,buddy_sticky:true,minimize_layout:false,msg_auto_pop:true}},{_init:function(){this.data=y({},this.options.data,this.data)},get:function(c){return this.data[c]},
set:function(c,g){var f=this,i=c;if(c){if(typeof c=="string"){i={};i[c]=g}var k=f.data,o=D(k,i);if(o){L(o,function(q,r){f.trigger("update",[q,r])});i=y({},k,i);f.data=i;C({type:"post",url:f.options.url,dataType:"json",cache:false,data:{data:P.encode(i)}})}}}});t("status",{key:"_webim"},{_init:function(){var c=this.data;if(c)this._save(c);else this.data=(c=na(this.options.key))?P.decode(c):{}},set:function(c,g){var f=c;if(typeof c=="string"){f={};f[c]=g}var i=this.data;D(i,f)&&this._save(y({},i,f))},
get:function(c){return this.data[c]},clear:function(){this._save({})},_save:function(c){this.data=c;na(this.options.key,P.encode(c),{path:"/",domain:v.domain})}});t("buddy",{url:"/webim/buddy"},{_init:function(){this.data=this.data||[];this.dataHash={};this._cacheData={};this.handle(this.data)},clear:function(){this.data=[];this.dataHash={};this._cacheData={}},count:function(c){var g=y({},this.dataHash,this._cacheData),f=0,i;for(var k in g)if(ka(c)){i=true;for(var o in c)if(c[o]!=g[k][o])i=false;
i&&f++}else f++;return f},get:function(c){return this.dataHash[c]},online:function(c){this.changeStatus(c,"online",true)},offline:function(c){this.changeStatus(c,"offline",false)},loadDelay:function(){var c=this._cacheData,g=[];for(var f in c)g.push(f);this.load(g)},update:function(c){this.load(c)},changeStatus:function(c,g,f){c=R(c);var i=c.length;if(i){for(var k=this._cacheData,o=this.dataHash,q=[],r,p=[],W,B=0;B<i;B++){r=c[B];if(o[r])q.push({id:r,presence:g});else{W={id:r,presence:g};if(!k[r]||
k[r].presence!=g)p.push(W);if(f)k[r]=W;else k[r]&&delete k[r]}}this.handle(q);if(f&&!this.options.loadDelay)this.loadDelay();else if(p.length)f?this.trigger(g+"Delay",[p]):this.trigger(g,[p])}},_loadSuccess:function(c){var g=this.self||this,f=g._cacheData,i,k;for(var o in c){i=c[o];k=i.id;if(f[k]){y(i,f[k]);delete f[k]}}g.handle(c)},load:function(c){c=R(c);c.length&&C({url:this.options.url,cache:false,dataType:"json",data:{ids:c.join(",")},context:this,success:this._loadSuccess})},handle:function(c){var g=
this.data,f=this.dataHash,i={};c=c||[];var k,o;for(var q in c){k=c[q];if(id=k.id){k.show=k.show?k.show:k.presence=="offline"?"unavailable":"available";if(!f[id]){f[id]={};g.push(f[id])}if(o=D(f[id],k)){k=o.presence||"update";i[k]=i[k]||[];y(f[id],o);i[k].push(f[id])}}}for(var r in i)this.trigger(r,[i[r]])}});(function(){t("room",{urls:{join:"/webim/join",leave:"/webim/leave",member:"/webim/members"}},{_init:function(){this.data=this.data||[];this.dataHash={}},get:function(c){return this.dataHash[c]},
block:function(c){var g=this.dataHash[c];if(g&&!g.blocked){g.blocked=true;var f=[];L(this.dataHash,function(i,k){k.blocked&&f.push(k.id)});this.trigger("block",[c,f])}},unblock:function(c){var g=this.dataHash[c];if(g&&g.blocked){g.blocked=false;var f=[];L(this.dataHash,function(i,k){k.blocked&&f.push(k.id)});this.trigger("unblock",[c,f])}},handle:function(c){var g=this,f=g.data,i=g.dataHash;L(c,function(k,o){var q=o.id;if(q){o.members=o.members||[];o.count=o.count||0;o.all_count=o.all_count||0;if(i[q])y(i[q],
o);else{i[q]=o;f.push(o)}g.trigger("join",[i[q]])}})},addMember:function(c,g){var f=this;if(ba(g))L(g,function(q,r){f.addMember(c,r)});else{var i=f.dataHash[c];if(i){i=i.members;for(var k,o=i.length;o--;)if(i[o].id==g.id)k=i[o];if(!k){g.nick=g.nick;i.push(g);f.trigger("addMember",[c,g])}}}},removeMember:function(c,g){var f=this.dataHash[c];if(f){for(var i=f.members,k,o=i.length;o--;)if(i[o].id==g){k=i[o];i.splice(o,1);f.count--}k&&self.trigger("removeMember",[c,k])}},initMember:function(c){var g=
this.dataHash[c];if(g&&!g.initMember){g.initMember=true;this.loadMember(c)}},loadMember:function(c){var g=this,f=g.options;C({cache:false,url:f.urls.member,dataType:"json",data:{ticket:f.ticket,id:c},success:function(i){g.addMember(c,i)}})},join:function(c,g){var f=this,i=f.options;C({cache:false,url:i.urls.join,dataType:"json",data:{ticket:i.ticket,id:c,nick:g.nick},success:function(k){f.initMember(c);f.handle([k])}})},leave:function(c,g){var f=this.options,i=this.dataHash[c];if(i){i.initMember=
false;C({cache:false,url:f.urls.leave,data:{ticket:f.ticket,id:c,nick:g.nick}});this.trigger("leave",[i])}},clear:function(){}})})();t("history",{urls:{load:"webim/history",clear:"webim/clear_history"}},{_init:function(){this.data=this.data||{};this.data.unicast=this.data.unicast||{};this.data.multicast=this.data.multicast||{}},unicast:function(c){return this.data.unicast[c]},multicast:function(c){return this.data.multicast[c]},handle:function(c){var g=this.data,f={unicast:{},multicast:{}};c=E(c);
var i=c.length,k,o,q=this.options.userInfo.id;if(i){for(var r=0;r<i;r++){k=c[r];p=k.type;if((o=p=="unicast"?k.to==q?k.from:k.to:k.to)&&p){f[p][o]=f[p][o]||[];f[p][o].push(k)}}for(var p in f)for(o in f[p]){k=f[p][o];if(g[p][o]){g[p][o]=g[p][o].concat(k);this._triggerMsg(p,o,k)}else this.load(p,o)}}},_triggerMsg:function(c,g,f){this.trigger(c,[g,f])},clear:function(c,g){var f=this.options;this.data[c][g]=[];this.trigger("clear",[c,g]);C({url:f.urls.clear,cache:false,data:{type:c,id:g}})},init:function(c,
g,f){if(ba(f)){this.data[c][g]=f;this._triggerMsg(c,g,f)}},load:function(c,g){var f=this,i=f.options;f.data[c][g]=[];C({url:i.urls.load,cache:false,dataType:"json",data:{type:c,id:g},success:function(k){f.init(c,g,k)}})}})})(window,document);
(function(w,v,aa){function oa(){return false}function V(a){var b="";if(a.length==0)return"";b=a.replace(/&/g,"&gt;");b=b.replace(/</g,"&lt;");b=b.replace(/>/g,"&gt;");b=b.replace(/    /g,"&nbsp;");b=b.replace(/\'/g,"&#39;");b=b.replace(/\"/g,"&quot;");return b=b.replace(/\n/g,"<br />")}function ba(a){return/^http:\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"])*$/.test(a)}function ka(a,b){for(var d=[];a;a=a.nextSibling)a.nodeType==1&&a!=b&&d.push(a);return d}function Y(a,b){return a&&
RegExp("(^|\\s+)"+b+"(\\s+|$)").test(a.className)}function D(a,b){if(a)Y(a,b)||(a.className+=" "+b)}function E(a,b){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," "))}function y(a,b,d){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," ")+" "+d)}function L(a,b,d){s(a,"mouseover",function(){D(this,b);d&&E(this,d)});s(a,"mouseout",function(){E(this,b);d&&D(this,d)})}function ha(a,b,d){if(typeof d===
"boolean")d?D(a,b):E(a,b);else Y(a,b)?E(a,b):D(a,b)}function F(a){a&&a.style&&(a.style.display="block")}function z(a){a&&a.style&&(a.style.display="none")}function C(a){a&&a.parentNode&&a.parentNode.removeChild(a)}function s(a,b,d){if(a.addEventListener)a.addEventListener(b,d,false);else{a["e"+b+d]=d;a[b+d]=function(){return a["e"+b+d](w.event)};a.attachEvent("on"+b,a[b+d])}}function Q(a){if(a){a.preventDefault&&a.preventDefault();a.returnValue=false}}function ja(a){if(!a.target)a.target=a.srcElement||
v;if(a.target.nodeType===3)a.target=a.target.parentNode;return a.target}function na(a){a.setAttribute("unselectable","on");a.style.MozUserSelect="none";s(a,"selectstart",oa)}function da(){if(!W){W=true;if(B){for(var a,b=0;a=B[b++];)a();B=null}}}function U(){if(!O){O=true;if(v.readyState==="complete")return da();if(v.addEventListener)v.addEventListener("DOMContentLoaded",function(){v.removeEventListener("DOMContentLoaded",arguments.callee,false);da()},false);else if(v.attachEvent){v.attachEvent("onreadystatechange",
function(){if(v.readyState==="complete"){v.detachEvent("onreadystatechange",arguments.callee);da()}});v.documentElement.doScroll&&w==w.top&&function(){if(!W){try{v.documentElement.doScroll("left")}catch(a){setTimeout(arguments.callee,0);return}da()}}()}s(w,"load",da)}}function R(a){var b=new Date;b.setTime(a?parseFloat(a)+R.timeSkew:(new Date).getTime());this.date=b}function t(a,b,d){d=f({locale:t.locale},d);d=t.dictionary[d.locale];$(d)||(d={});a=d[a]===aa?a:d[a];if(b){A=b;for(var e in b)a=a.replace(/\{\{(.*?)\}\}/g,
ta)}return a}function x(a,b){this.element=a;this.options=f({},x.defaults,b);this._init()}function fa(a){a=a.getElementsByTagName("*");for(var b,d,e={},h=a.length-1;h>-1;h--){b=a[h];if((d=b.id)&&d.indexOf(":")==0)e[d.substring(1,d.length)]=b}return e}function H(a){var b=v.createElement("div");b.innerHTML=a;return b=b.firstChild}function K(a,b,d){function e(h,j){this.id=ma++;this.name=a;this.className="webim-"+a;this.options=f({},e.defaults,j);if(this.element=h||this.template&&H(this.template())||this.options.template&&
H(G(this.options.template))){this.options.className&&D(this.element,this.options.className);this.$=fa(this.element)}Z(this._init)&&this._init();Z(this._initEvents)&&this._initEvents()}e.defaults=b;f(e.prototype,r,K.prototype,d);x[a]=e}function ea(a,b){x.apps[a]=b||{}}function ia(a,b){return b?a=="b"||a=="buddy"||a=="unicast"?"b_"+b:"r_"+b:a}function pa(){v.selection&&(this.caretPos=v.selection.createRange())}var la=webim.idsArray,Z=webim.isFunction,P=webim.isArray,$=webim.isObject,c=webim.trim,g=
webim.makeArray,f=webim.extend,i=webim.each,k=webim.grep,o=webim.ajax,q=webim.model,r=webim.objectExtend,p=webim.map,W=false,B=[],O=false;R.timeSkew=0;R.init=function(a){R.timeSkew=(new Date).getTime()-parseFloat(a)};f(R.prototype,{getTime:function(){var a=this.date,b=a.getHours();a=a.getMinutes();if(a<10)a="0"+a;return b+":"+a+""},getDay:function(a){var b=this.date;if(a){a=new Date;a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);a=a.getTime()-b.getTime();if(a<=0)return t("dt:today");
else if(a<864E5)return t("dt:yesterday")}return t("dt:monthdate",{month:t(["dt:january","dt:february","dt:march","dt:april","dt:may","dt:june","dt:july","dt:august","dt:september","dt:october","dt:november","dt:december"][b.getMonth()]),date:b.getDate()})}});var T=function(){var a=true,b={lib:"sound.swf",msg:"sound/msg.mp3"};return{enable:function(){a=true},disable:function(){a=false},init:function(d){f(b,d);d=b.lib+"?_"+(new Date).getTime();d=navigator.plugins&&navigator.mimeTypes&&navigator.mimeTypes.length?
'<embed type="application/x-shockwave-flash" width="10" height="10" id="webim-flashlib" allowscriptaccess="always" src="'+d+'" />':'<object width="10" height="10" id="webim-flashlib" type="application/x-shockwave-flash" data="'+d+'">\t\t\t\t<param name="allowScriptAccess" value="always" />\t\t\t\t<param name="movie" value="'+d+'" />\t\t\t\t<param name="scale" value="noscale" />\t\t\t\t</object>';try{v.getElementById("webim-flashlib-c").innerHTML=d}catch(e){}},play:function(d){d=ba(d)?d:b[d];if(a)try{v.getElementById("webim-flashlib").playSound(d?
d:"/sound/sound.mp3")}catch(e){}}}}(),ca=function(){var a=false;s(w,"focus",function(){a=false});s(w,"blur",function(){a=true});var b=v.title,d=0,e=false;return function(h,j){if(a){if(l){clearInterval(l);d=0;e=false}var l=setInterval(function(){d++;e=!e;if(d==j||!a){clearInterval(l);d=0;e=false}v.title=e?"["+h+"]"+b:b},1500)}}}(),A={},ta=function(a,b){return A[b]||""};t.locale="zh-CN";t.dictionary={};t.store=function(a,b){var d=t.dictionary;$(d[a])||(d[a]={});f(d[a],b)};f(x.prototype,r,{render:function(){var a=
this,b=a.layout;a.element.appendChild(b.element);setTimeout(function(){a.initSound()},1E3);b.buildUI()},_init:function(){var a=this.im=new webim,b=this.layout=new x.layout(null,{chatAutoPop:a.setting.get("msg_auto_pop")});a.setting.get("play_sound")?T.enable():T.disable();a.setting.get("minimize_layout")?b.collapse():b.expand();this._initEvents()},addApp:function(a,b){var d=x.apps[a];if(d){var e=this,h=e.im;Z(d.init)&&d.init.apply(e,[b]);Z(d.ready)&&h.bind("ready",function(){d.ready.apply(e,arguments)});
Z(d.go)&&h.bind("go",function(){d.go.apply(e,arguments)});Z(d.stop)&&h.bind("stop",function(){d.stop.apply(e,arguments)})}},initSound:function(a){T.init(a||this.options.soundUrls)},_initEvents:function(){var a=this,b=a.im,d=b.buddy,e=b.history,h=b.setting,j=a.layout;b.bind("ready",function(){j.changeState("ready")}).bind("go",function(l){j.changeState("active");j.option("user",l.user);R.init(l.server_time);a._initStatus()}).bind("stop",function(l){j.changeState("stop");l=="offline"&&j.removeAllChat();
j.updateAllChat()});h.bind("update",function(l,m){switch(l){case "play_sound":m?T.enable():T.disable();break;case "msg_auto_pop":j.option("chatAutoPop",m);break;case "minimize_layout":m?j.collapse():j.expand();break}});d.bind("online",function(l){j.updateChat("buddy",l)}).bind("offline",function(l){j.updateChat("buddy",l)}).bind("update",function(l){j.updateChat("buddy",l)});j.bind("collapse",function(){h.set("minimize_layout",true)});j.bind("expand",function(){h.set("minimize_layout",false)});j.bind("displayUpdate",
function(){a._updateStatus()});b.bind("message",function(l){for(var m=false,n=l.length,u,I=b.data.user.id,N,X,ga=0;ga<n;ga++){u=l[ga];N=u.id;type=u.type;(X=j.chat(type,N))&&X.status("");if(!X){u.type==="unicast"?a.addChat(type,N,null,null,u.nick):a.addChat(type,N);X=j.chat(type,N)}X&&h.get("msg_auto_pop")&&!j.activeTabId&&j.focusChat(N);X.window.notifyUser("information","+1");N=X.window.pos;N==-1&&j.setNextMsgNum("+1");N==1&&j.setPrevMsgNum("+1");if(u.from!=I)m=true}if(m){T.play("msg");ca(t("new message"),
5)}});b.bind("status",function(l){i(l,function(m,n){var u=b.data.user.id,I=n.from;if(!(u!=n.to&&u!=n.from))(u=j.chat("buddy",I))&&u.status(n.show)})});e.bind("unicast",function(l,m){var n=j.chat("unicast",l);n&&n.history.add(m)});e.bind("multicast",function(l,m){var n=j.chat("multicast",l);n&&n.history.add(m)});e.bind("clear",function(l,m){var n=j.chat(l,m);n&&n.history.clear()})},__status:false,_initStatus:function(){var a=this,b=a.layout;if(a.__status)return b.updateAllChat();a.__status=true;var d=
a.im.status,e=d.get("tabs"),h=d.get("tabIds"),j=d.get("p");d=d.get("a");h&&h.length&&e&&i(e,function(l,m){var n=l.slice(2);a.addChat(l[0],n,{},{isMinimize:true});b.chat(l).window.notifyUser("information",m.n)});j&&(b.prevCount=j)&&b._fitUI();d&&b.focusChat(d)},addChat:function(a,b,d,e,h){a=a=="b"||a=="buddy"||a=="unicast"?"buddy":"room";var j=this,l=j.layout,m=j.im,n=j.im.history,u=m.buddy,I=m.room;if(!l.chat(a,b))if(a=="room"){var N=n.multicast(b),X=I.get(b);h=X||{id:b,nick:h||b};h.presence="online";
l.addChat(a,h,f({history:N,block:true,emot:true,clearHistory:false,member:true,msgType:"multicast"},d),e);N||n.load("multicast",b);var ga=l.chat(a,b);ga.bind("sendMsg",function(J){m.sendMsg(J);n.handle(J)}).bind("select",function(J){u.online(J.id);j.addChat("buddy",J.id,null,null,J.nick);l.focusChat("buddy",J.id)}).bind("block",function(J){I.block(J.id)}).bind("unblock",function(J){I.unblock(J.id)}).window.bind("close",function(){ga.options.info.blocked&&I.leave(b)});setTimeout(function(){ga.options.info.blocked?
I.join(b):I.initMember(b)},500);P(h.members)&&i(h.members,function(J,sa){ga.addMember(sa.id,sa.nick,sa.id==m.data.user.id)})}else{N=n.unicast(b);h=(X=u.get(b))||{id:b,nick:h||b};l.addChat(a,h,f({history:N,block:false,emot:true,clearHistory:true,member:false,msgType:"unicast"},d),e);X||u.update(b);N||n.load("unicast",b);l.chat(a,b).bind("sendMsg",function(J){m.sendMsg(J);n.handle(J)}).bind("sendStatus",function(J){m.sendStatus(J)}).bind("clearHistory",function(J){n.clear("unicast",J.id)})}},_updateStatus:function(){var a=
this.layout,b={};i(a.tabs,function(d,e){b[d]={n:e._count()}});this.im.status.set({tabs:b,tabIds:a.tabIds,p:a.prevCount,a:a.activeTabId})}});var S=function(a,b){if(b===aa)return parseInt(a.innerHTML);else if(b){b=typeof b=="number"?b:parseInt(a.innerHTML)+parseInt(b);a.innerHTML=b.toString();F(a)}else{a.innerHTML="0";z(a)}return b},G=function(){function a(e,h){return b&&b[h]!=aa?b[h]:t(h)}var b=null,d=/\<\%\=(.*?)\%\>/ig;return function(e,h){if(!e)return"";b=h;return e.replace(d,a)}}(),M={add:function(a,
b,d){a=x[a].prototype;for(var e in d){a.plugins[e]=a.plugins[e]||[];a.plugins[e].push([b,d[e]])}},call:function(a,b,d){if((b=a.plugins[b])&&a.element.parentNode)for(var e=0;e<b.length;e++)a.options[b[e][0]]&&b[e][1].apply(a.element,d)}},ma=1;f(K.prototype,{_init:function(){}});f(x,{version:"1.0.0pre",widget:K,app:ea,plugin:M,i18n:t,date:R,ready:function(a){U();W?a():B.push(a)},createElement:H,defaults:{},apps:{}});webim.ui=x;K("window",{isMinimize:false,minimizable:true,maximizable:false,closeable:true,
sticky:true,titleVisibleLength:12,count:0,template:'<div id=":webim-window" class="webim-window ui-widget">                                            <div class="webim-window-tab-wrap">                                            <div id=":tab" class="webim-window-tab ui-state-default">                                            <div class="webim-window-tab-inner">                                                    <div id=":tabTip" class="webim-window-tab-tip">                                                            <strong id=":tabTipC"><%=tooltip%></strong>                                                    </div>                                                    <a id=":tabClose" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                    <div id=":tabCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <em id=":tabIcon" class="webim-icon webim-icon-comments"></em>                                                    <h4 id=":tabTitle"><%=title%></h4>                                            </div>                                            </div>                                            </div>                                            <div><div id=":window" class="webim-window-window">\t\t\t\t\t\t<iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe>                                                    <div id=":header" class="webim-window-header ui-widget-header ui-corner-top">                                                            <span id=":actions" class="webim-window-actions">                                                                    <a id=":minimize" title="<%=minimize%>" class="webim-window-minimize" href="#minimize"><em class="ui-icon ui-icon-minus"><%=minimize%></em></a>                                                                    <a id=":maximize" title="<%=maximize%>" class="webim-window-maximize" href="#maximize"><em class="ui-icon ui-icon-plus"><%=maximize%></em></a>                                                                    <a id=":close" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                            </span>                                                            <h4 id=":headerTitle"><%=title%></h4>                                                            <div id=":subHeader" class="webim-window-subheader"></div>                                                    </div>                                                    <div id=":content" class="webim-window-content ui-widget-content">                                                    </div>                                            </div>                                            </div>                                            </div>'},
{html:function(a){return this.$.content.appendChild(a)},subHeader:function(a){this.$.subHeader.innerHTML="";return this.$.subHeader.appendChild(a)},_init:function(a,b){b=this.options;var d=this.$;a=this.element;a.window=this;b.tabWidth&&(d.tab.style.width=b.tabWidth+"px");b.subHeader&&this.subHeader(b.subHeader);this.title(b.title,b.icon);!b.minimizable&&z(d.minimize);!b.maximizable&&z(d.maximize);if(!b.closeable){z(d.tabClose);z(d.close)}b.isMinimize?this.minimize():this.restore();b.onlyIcon?z(d.tabTitle):
C(d.tabTip);b.count&&this.notifyUser("information",b.count);qa(this)},notifyUser:function(a,b){var d=this.$;if(a=="information")if(this.isMinimize())if(S(d.tabCount,b)){D(d.tab,"ui-state-highlight");E(d.tab,"ui-state-default")}},_count:function(){return S(this.$.tabCount)},title:function(a,b){var d=this.$,e=d.tabIcon;if(b)if(ba(b)){e.className="webim-icon";e.style.backgroundImage="url("+b+")"}else e.className="webim-icon webim-icon-"+b;d.tabTipC.innerHTML=a;e=this.options.titleVisibleLength;if(a){for(var h=
0,j=[],l=a.split(""),m=l.length,n=0;n<m;n++)if(h>=e||h<0)break;else{if(l[n].charCodeAt(0)>255)h+=2;else h++;j.push(l[n])}e=j.join("")}else e=a;(d.tabTitle.innerHTML=e)&&a&&e.length<a.length&&d.tabTitle.setAttribute("title",a);d.headerTitle.innerHTML=a},_changeState:function(a){y(this.element,"webim-window-normal webim-window-maximize webim-window-minimize","webim-window-"+(a=="restore"?"normal":a));this.trigger("displayStateChange",[a])},active:function(){return Y(this.element,"webim-window-active")},
activate:function(){if(!this.active()){D(this.element,"webim-window-active");this.trigger("activate")}},deactivate:function(){if(this.active()){E(this.element,"webim-window-active");this.options.sticky||this.minimize();this.trigger("deactivate")}},_setVisibile:function(){var a=this.$;y(a.tab,"ui-state-default ui-state-highlight","ui-state-active");this.activate();S(a.tabCount,0)},maximize:function(){if(!this.isMaximize()){this._setVisibile();this._changeState("maximize")}},restore:function(){if(!Y(this.element,
"webim-window-normal")){this._setVisibile();this._changeState("restore")}},minimize:function(){if(!this.isMinimize()){y(this.$.tab,"ui-state-active","ui-state-default");this.deactivate();this._changeState("minimize")}},tabClose:function(){this.close()},close:function(){this.trigger("close");C(this.element)},_initEvents:function(){var a=this,b=a.$,d=b.tab,e=function(h){if(h){h.stopPropagation&&h.stopPropagation();h.cancelBubble=true}Q(h)};s(d,"click",function(h){a.isMinimize()?a.restore():a.minimize();
e(h)});s(d,"mouseover",function(){D(this,"ui-state-hover");E(this,"ui-state-default")});s(d,"mouseout",function(){E(this,"ui-state-hover");this.className.indexOf("ui-state-")==-1&&D(this,"ui-state-default")});s(d,"mousedown",e);na(d);i(ka(b.actions.firstChild),function(h,j){L(j,"ui-state-hover")});i(["minimize","maximize","close","tabClose"],function(h,j){s(b[j],"click",function(l){this.disabled||a[j]();e(l)});s(b[j],"mousedown",e)})},height:function(){return this.$.content.offsetHeight},_fitUI:function(){},
isMaximize:function(){return Y(this.element,"webim-window-maximize")},isMinimize:function(){return Y(this.element,"webim-window-minimize")}});var qa=function(){var a=false,b=function(){a&&a.deactivate();a=false;return true},d=function(){this&&this!=a&&b()&&(a=this)},e=function(){this&&a==this&&(a=false)};s(v,"mousedown",function(h){h=ja(h);for(var j;h;)if(h.id==":webim-window"){j=h;break}else h=h.parentNode;if(j)(h=j.window)&&h.activate();else b()});return function(h){if(h.active()){b();a=h}h.bind("activate",
d);h.bind("deactivate",e)}}();K("layout",{template:'<div id="webim" class="webim webim-state-ready">                    <div class="webim-preload ui-helper-hidden-accessible">                    <div id="webim-flashlib-c">                    </div>                    </div><div id=":layout" class="webim-layout"><iframe class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><div class="webim-layout-bg ui-state-default ui-toolbar"></div><div class="webim-ui ui-helper-clearfix">                            <div id=":shortcut" class="webim-shortcut">                            </div>                            <div class="webim-layout-r">                            <div id=":panels" class="webim-panels">                                <div class="webim-window-tab-wrap ui-widget webim-panels-next-wrap">                                            <div id=":next" class="webim-window-tab webim-panels-next ui-state-default">                                                    <div id=":nextMsgCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <em class="ui-icon ui-icon-triangle-1-w"></em>                                                    <span id=":nextCount">0</span>                                            </div>                                </div>                                <div id=":tabsWrap" class="webim-panels-tab-wrap">                                        <div id=":tabs" class="webim-panels-tab">                                        </div>                                </div>                                <div class="webim-window-tab-wrap ui-widget webim-panels-prev-wrap">                                            <div id=":prev" class="webim-window-tab webim-panels-prev ui-state-default">                                                    <div id=":prevMsgCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <span id=":prevCount">0</span>                                                    <em class="ui-icon ui-icon-triangle-1-e"></em>                                            </div>                                </div>                                <div class="webim-window-tab-wrap webim-collapse-wrap ui-widget">                                            <div id=":collapse" class="webim-window-tab webim-collapse ui-state-default" title="<%=collapse%>">                                                    <em class="ui-icon ui-icon-circle-arrow-e"></em>                                            </div>                                </div>                                <div class="webim-window-tab-wrap webim-expand-wrap ui-widget">                                            <div id=":expand" class="webim-window-tab webim-expand ui-state-default" title="<%=expand%>">                                                    <em class="ui-icon ui-icon-circle-arrow-w"></em>                                            </div>                                </div>                            </div>                            <div id=":widgets" class="webim-widgets">                            </div>                            </div>            </div></div>                    </div>',
shortcutLength:5,chatAutoPop:true,tpl_shortcut:'<div class="webim-window-tab-wrap ui-widget webim-shortcut-item"><a class="webim-window-tab" href="<%=link%>" target="<%=target%>">                                                    <div class="webim-window-tab-tip">                                                            <strong><%=title%></strong>                                                    </div>                                                    <em class="webim-icon" style="background-image:url(<%=icon%>)"></em>                                            </a>                                            </div>'},
{_init:function(a,b){b=this.options;f(this,{window:w,widgets:{},panels:{},tabWidth:136,maxVisibleTabs:null,animationTime:210,activeTabId:null,tabs:{},tabIds:[],nextCount:0,prevCount:0});b.isMinimize&&this.collapse()},changeState:function(a){this.element.className="webim webim-state-"+a},_ready:false,buildUI:function(){var a=this.$;this.maxVisibleTabs=parseInt(((v.compatMode==="CSS1Compat"&&v.documentElement.clientWidth||v.body.clientWidth)-45-a.shortcut.offsetWidth-a.widgets.offsetWidth-70)/this.tabWidth);
this._fitUI();this._ready=true},_updatePrevCount:function(a){var b=this.tabIds,d=this.maxVisibleTabs,e=b.length,h=this.prevCount;if(!(e<=d)){if(a){for(var j=0,l=0;l<e;l++)if(b[l]==a){j=l;break}if(j<=h)h=j;else if(j>=h+d)h=j-d+1}else h=e-d;this.prevCount=h}},_setVisibleTabs:function(a){for(var b=this.prevCount,d=b+this.maxVisibleTabs,e=this.tabs,h=this.tabIds,j=h.length,l=0,m=0,n=0;n<j;n++){var u=e[h[n]];if(n<b||n>=d)if(a)F(u.element);else{this.activeTabId==h[n]&&u.minimize();var I=u._count();if(n<
b){m+=I;u.pos=1}else{l+=I;u.pos=-1}z(u.element)}else{u.pos=0;F(u.element)}}if(!a){this.setNextMsgNum(l);this.setPrevMsgNum(m)}},setNextMsgNum:function(a){S(this.$.nextMsgCount,a)},setPrevMsgNum:function(a){S(this.$.prevMsgCount,a)},slideing:false,_slide:function(a){var b=this,d=b.prevCount,e=b.nextCount;if(e>0&&a==-1||d>0&&a==1){b.slideing=true;if(e==1&&a==-1||d==1&&a==1)b.slideing=false;b._slideSetup(false);b._setVisibleTabs(true);if(a==-1){b.nextCount--;b.prevCount++}else if(a==1){b.nextCount++;
b.prevCount--}var h=b.$.tabs,j=parseFloat(h.style.left);d=-1*b.tabWidth*b.nextCount;var l=parseInt(500/13),m=1,n=(d-j)/l,u=setInterval(function(){h.style.left=j+n*m+"px";if(m==l){if(b.slideing)b._slide(a);else{b._fitUI();b._slideReset()}clearInterval(u)}else m++},13)}},_slideUp:function(){this.slideing=false},_slideSetup:function(a){var b=this.$,d=b.tabsWrap;b=b.tabs;if(!this._tabsWidth)this._tabsWidth=b.clientWidth;if(a)this._tabsWidth=null;d.style.position=a?"":"relative";d.style.overflow=a?"visible":
"hidden";d.style.width=a?"":this._tabsWidth+"px";b.style.width=a?"":this.tabWidth*this.tabIds.length+"px";b.style.position=a?"":"relative"},_slideReset:function(){this._slideSetup(true)},_updateCount:function(){var a=this.maxVisibleTabs,b=this.tabIds.length,d=this.prevCount,e=this.nextCount;if(b<=a)d=e=0;else{e=b-a-d;e=e<0?0:e;d=b-a-e}this.prevCount=d;this.nextCount=e},_updateCountUI:function(){var a=this.$,b=this.prevCount,d=this.nextCount;d<=0?D(a.next,"ui-state-disabled"):E(a.next,"ui-state-disabled");
b<=0?D(a.prev,"ui-state-disabled"):E(a.prev,"ui-state-disabled");if(b>0||d>0){a.next.style.display="block";a.prev.style.display="block"}else{z(a.next);z(a.prev)}a.nextCount.innerHTML=d.toString();a.prevCount.innerHTML=b.toString()},_initEvents:function(){var a=this,b=a.$;s(a.window,"resize",function(){a.buildUI()});s(b.next,"mousedown",function(){a._slide(-1)});s(b.next,"mouseup",function(){a._slideUp()});na(b.next);s(b.prev,"mousedown",function(){a._slide(1)});s(b.prev,"mouseup",function(){a._slideUp()});
na(b.prev);s(b.expand,"click",function(){a.expand();return false});s(b.collapse,"click",function(){a.collapse();return false});L(b.collapse,"ui-state-hover","ui-state-default");L(b.expand,"ui-state-hover","ui-state-default")},isMinimize:function(){return Y(this.$.layout,"webim-layout-minimize")},collapse:function(){if(!this.isMinimize()){D(this.$.layout,"webim-layout-minimize");this.trigger("collapse")}},expand:function(){if(this.isMinimize()){E(this.$.layout,"webim-layout-minimize");this.trigger("expand")}},
_displayUpdate:function(){this._ready&&this.trigger("displayUpdate")},_fitUI:function(){this._updateCount();this.$.tabs.style.left=-1*this.tabWidth*this.nextCount+"px";this._updateCountUI();this._setVisibleTabs();this._displayUpdate()},_stickyWin:null,_widgetStateChange:function(a,b){b!="minimize"&&i(this.widgets,function(d,e){e.window!=a&&e.window.minimize()});this._displayUpdate()},widget:function(a){return this.widgets[a]},addWidget:function(a,b,d,e){var h=this;b=f(b,{closeable:false,subHeader:a.header});
var j=a.element;b=new x.window(null,b);b.html(j);h.$[e?e:"widgets"].insertBefore(b.element,d&&h.widgets[d]?h.widgets[d].window.element:null);a.window=b;b.bind("displayStateChange",function(l){h._widgetStateChange(this,l)});h.widgets[a.name]=a},focusChat:function(a,b){b=ia(a,b);var d=this.tabs[b],e=this.panels[b];d&&d.isMinimize()&&d.restore();e&&e.focus()},chat:function(a,b){return this.panels[ia(a,b)]},updateChat:function(a,b){b=g(b);for(var d,e=b.length,h,j=0;j<e;j++){d=b[j];(h=this.panels[ia(a,
d.id)])&&h.update(d)}},updateAllChat:function(){i(this.panels,function(a,b){b.update()})},_onChatClose:function(a){this.tabIds=k(this.tabIds,function(b){return b!=a});delete this.tabs[a];delete this.panels[a];this._changeActive(a,true);this._fitUI()},_onChatChange:function(a,b){if(b=="minimize"){this._changeActive(a,true);this._displayUpdate()}else{this._changeActive(a);this._fitUI()}},_changeActive:function(a,b){var d=this.activeTabId;if(b)d==a&&(this.activeTabId=null);else{d&&d!=a&&this.tabs[d].minimize();
this.activeTabId=a;this._updatePrevCount(a)}},addChat:function(a,b,d,e){var h=this,j=h.panels,l=b.id;l=ia(a,l);if(!j[l]){a=h.tabs[l]=(new x.window(null,f({isMinimize:h.activeTabId||!h.options.chatAutoPop,tabWidth:h.tabWidth-2},e))).bind("close",function(){h._onChatClose(l)}).bind("displayStateChange",function(m){h._onChatChange(l,m)});h.tabIds.push(l);h.$.tabs.insertBefore(a.element,h.$.tabs.firstChild);j[l]=new x.chat(null,f({window:a,user:h.options.user,info:b},d));!a.isMinimize()&&h._changeActive(l);
h._fitUI()}},removeChat:function(a,b){var d=this.tabs[ia(a,b)];d&&d.close()},removeAllChat:function(){i(this.tabs,function(a,b){b.close()})},addShortcut:function(a){var b=this;if(P(a))i(a,function(h,j){b.addShortcut(j)});else if($(a)){var d=b.$.shortcut,e=b.options.tpl_shortcut;if(!(d.childNodes.length>b.options.shortcutLength+1)){e=H(G(e,{title:t(a.title),icon:a.icon,link:a.link,target:a.isExtlink?"_blank":""}));L(e.firstChild,"ui-state-hover");d.appendChild(e)}}},addWindow:function(){new x.window(null,
{})},online:function(){},offline:function(){}});K("history",{user:{},info:{},template:'<div class="webim-history">                        <div id=":content" class="webim-history-content">                 </div></div>'},{_init:function(){M.call(this,"init",[null,this.ui()])},clear:function(){this.$.content.innerHTML="";this.trigger("clear")},add:function(a){a=g(a);var b=a.length,d=[];if(b){for(var e=0;e<b;e++)d.push(this._renderMsg(a[e]));this.$.content.innerHTML+=d.join("");this.trigger("update")}},
_renderMsg:function(a){a=f({},a);M.call(this,"render",[null,this.ui({msg:a})]);var b=a.from,d=a.to,e=a.timestamp,h=a.body,j=true,l=this._lastLogItem,m=[],n;n=a.nick;if(l&&l.to==d&&l.from==b&&e-l.timestamp<6E4)j=false;if(j){this._lastLogItem=a;a=new R(e);m.push('<h4 class="ui-state-default"><span class="webim-gray">');m.push(a.getDay(true));m.push(" ");m.push(a.getTime());m.push("</span>");m.push(n);m.push("</h4>")}m.push("<p>");m.push(h);m.push("</p>");return m.join("")},_renderDateBreak:function(a){var b=
this._lastLogItem,d=new Date,e=new Date,h=[];d.setTime(a);b&&e.setTime(b.timestamp);if(!b||d.getDate()!=e.getDate()||d.getMonth()!=e.getMonth()){h.push("<h5>");h.push((new R(a)).getDay(true));h.push("</h5>")}return h.join("")},ui:function(a){return f({element:this.element,$:this.$},a)},plugins:{}});var ra=function(){function a(e,h){return'<a href="'+(h=="www."?"http://"+e:e)+'"'+d+">"+e+"</a>"}function b(e,h){d+=" "+e+'="'+h+'"'}var d;return function(e,h){d="";h&&$(h)&&i(h,b);return e.replace(/(https?:\/\/|www\.)([^\s<]+)/ig,
a)}}();x.history.defaults.parseMsg=true;M.add("history","parseMsg",{render:function(a,b){var d=b.msg.body;d=V(d);d=ra(d,{target:"_blank"});b.msg.body=d}});x.history.defaults.emot=true;M.add("history","emot",{render:function(a,b){b.msg.body=x.emot.parse(b.msg.body)}});K("emot",{template:'<div class="webim-emot ui-widget-content"><%=emots%></div>'},{_init:function(){var a=this,b=a.element;i(b.firstChild.childNodes,function(d,e){s(e,"click",function(){E(b,"webim-emot-show");a.trigger("select",this.firstChild.getAttribute("alt"))})})},
template:function(){var a=this.emots=webim.ui.emot.emots,b=[];b.push('<ul class="ui-helper-clearfix">');i(a,function(d,e){var h=e.src,j=e.t?e.t:e.q[0];b.push('<li><img src="');b.push(h);b.push('" title="');b.push(j);b.push('" alt="');b.push(e.q[0]);b.push('" /></li>')});b.push("</ul>");return G(this.options.template,{emots:b.join("")})},toggle:function(){ha(this.element,"webim-emot-show")}});f(x.emot,{emots:[{t:"smile",src:"smile.png",q:[":)"]},{t:"smile_big",src:"smile-big.png",q:[":d",":-d",":D",
":-D"]},{t:"sad",src:"sad.png",q:[":(",":-("]},{t:"wink",src:"wink.png",q:[";)",";-)"]},{t:"tongue",src:"tongue.png",q:[":p",":-p",":P",":-P"]},{t:"shock",src:"shock.png",q:["=-O","=-o"]},{t:"kiss",src:"kiss.png",q:[":-*"]},{t:"glasses_cool",src:"glasses-cool.png",q:["8-)"]},{t:"embarrassed",src:"embarrassed.png",q:[":-["]},{t:"crying",src:"crying.png",q:[":'("]},{t:"thinking",src:"thinking.png",q:[":-/",":-\\"]},{t:"angel",src:"angel.png",q:["O:-)","o:-)"]},{t:"shut_mouth",src:"shut-mouth.png",q:[":-X",
":-x"]},{t:"moneymouth",src:"moneymouth.png",q:[":-$"]},{t:"foot_in_mouth",src:"foot-in-mouth.png",q:[":-!"]},{t:"shout",src:"shout.png",q:[">:o",">:O"]}],init:function(a){var b=webim.ui.emot,d=b._q={};a=f({dir:"webim/static/emot/default"},a);if(a.emots)b.emots=a.emots;var e=a.dir+"/";i(b.emots,function(h,j){if(j&&j.src)j.src=e+j.src;j&&j.q&&i(j.q,function(l,m){d[m]=h})})},parse:function(a){var b=webim.ui.emot._q,d=webim.ui.emot.emots;b&&i(b,function(e,h){var j=d[h],l=j.src,m=j.t?j.t:j.q[0],n=[];
n.push('<img src="');n.push(l);n.push('" title="');n.push(m);n.push('" alt="');n.push(j.q[0]);n.push('" />');e=V(e);e=e.replace(RegExp("(\\"+".$^*\\[]()|+?{}:<>".split("").join("|\\")+")","g"),"\\$1");a=a.replace(RegExp(e,"g"),n.join(""))});return a}});K("chat",{tpl_header:'<div><div id=":user" class="webim-user"> \t\t\t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" src="about:blank" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t\t\t<span id=":userStatus" title="" class="webim-user-status">&nbsp;</span> \t\t     </div></div>',
template:'<div class="webim-chat"> \t\t\t\t<div class="webim-chat-notice-wrap"><div id=":notice" class="webim-chat-notice ui-state-highlight"></div></div>                                                 <div id=":content" class="webim-chat-content">                                                                                                                 <div id=":status" class="webim-chat-status webim-gray"></div>                                                 </div>                                                 <div id=":actions" class="webim-chat-actions">                                                         <div id=":toolContent" class="webim-chat-tool-content"></div>                                                        <div id=":tools" class="webim-chat-tools ui-helper-clearfix ui-state-default"></div>                                                        <table class="webim-chat-t" cellSpacing="0">                                                                 <tr>                                                                         <td style="vertical-align:top;">                                                                         <em class="webim-icon webim-icon-chat-edit"></em>                                                                        </td>                                                                         <td style="vertical-align:top;width:100%;">                                                                         <div class="webim-chat-input-wrap">                                                                                <textarea id=":input" class="webim-chat-input webim-gray ui-widget-content"><%=input notice%></textarea>                                                                         </div>                                                                         </td>                                                                 </tr>                                                         </table>                                                 </div>                                         </div>'},
{_init:function(){var a=this.element,b=this.options,d=this.window=b.window,e=this.history=new x.history(null,{user:b.user,info:b.info});this.$.content.insertBefore(e.element,this.$.content.firstChild);this.header=H(G(b.tpl_header));f(this.$,fa(this.header));if(d){d.subHeader(this.header);d.html(a);this._bindWindow()}this.update(b.info);e.add(b.history);M.call(this,"init",[null,this.ui()]);this._adjustContent()},update:function(a){if(a){this.option("info",a);this.history.option("info",a);this._updateInfo(a)}a=
this.options.info.presence=="online";if(this.options.user.presence=="online")a?this.notice(""):this.notice(t("buddy offline notice",{name:this.options.info.nick}));else this.notice(t("user offline notice"));M.call(this,"update",[null,this.ui()])},focus:function(){var a=this.$.input;w.setTimeout(function(){a.focus()},0)},_noticeTime:null,_noticeTxt:"",notice:function(a,b){var d=this,e=d.$.notice,h=d._noticeTime;h&&clearTimeout(h);if(a)if(b){e.innerHTML=a;F(e);setTimeout(function(){if(d._noticeTxt)e.innerHTML=
d._noticeTxt;else z(e,500)},b)}else{d._noticeTxt=a;e.innerHTML=a;F(e)}else{d._noticeTxt=null;z(e)}},_adjustContent:function(){var a=this.$.content;a.scrollTop=a.scrollHeight},_fitUI:function(){this._adjustContent()},_bindWindow:function(){var a=this;a.window.bind("displayStateChange",function(b){if(b!="minimize"){w.setTimeout(function(){a.$.input.focus()},0);a._adjustContent()}})},_inputAutoHeight:function(){var a=this.$.input,b=a[0].scrollTop;if(b>0){var d=a.height();d>32&&d<100&&a.height(d+b)}},
_sendMsg:function(a){var b=this.options,d=b.info;a={type:b.msgType,to:d.id,from:b.user.id,nick:b.user.nick,offline:d.presence!="online",timestamp:(new Date).getTime(),body:a};M.call(this,"send",[null,this.ui({msg:a})]);this.trigger("sendMsg",a)},_inputkeypress:function(a){if(a.keyCode==13)if(a.ctrlKey){this.insert("\n",true);return true}else{var b=ja(a),d=b.value;if(c(d)){this._sendMsg(d);b.value="";Q(a)}}else this._typing()},_onFocusInput:function(a){var b=this;ja(a);(w.getSelection?w.getSelection().toString():
v.selection?v.selection.createRange().text:"")||w.setTimeout(function(){b.$.input.focus()},0)},_initEvents:function(){var a=this,b=a.$,d=t("input notice"),e=b.input;a.history.bind("update",function(){a._adjustContent()}).bind("clear",function(){a.notice(t("clear history notice"),3E3)});s(e,"keyup",function(){pa.call(this)});s(e,"click",pa);s(e,"select",pa);s(e,"focus",function(){E(this,"webim-gray");if(this.value==d)this.value=""});s(e,"blur",function(){if(this.value==""){D(this,"webim-gray");this.value=
d}});s(e,"keypress",function(h){a._inputkeypress(h)});s(b.content,"click",function(h){a._onFocusInput(h)})},_updateInfo:function(a){var b=this.$;b.userPic.setAttribute("href",a.url);b.userPic.firstChild.setAttribute("defaultsrc",a.default_pic_url?a.default_pic_url:"");setTimeout(function(){b.userPic.firstChild.setAttribute("src",a.pic_url)},100);b.userStatus.innerHTML=a.status||"&nbsp";this.window.title(a.nick,a.show)},insert:function(a,b){var d=this.$.input;d.focus();if(b){a||(a="");if(d.setSelectionRange){var e=
d.value,h=d.selectionStart,j=d.selectionEnd,l=e.substring(0,h);e=e.substring(j);j=a.length;d.value=l+a+e;d.setSelectionRange(h+j,h+j)}else if(v.selection)if(h=d.caretPos){h.text=a;h.collapse();h.select()}else d.value+=a;else d.value+=a}else d.value=a},_statusText:"",sendStatus:function(a){if(!(!a||a==this._statusText||this.options.info.presence=="offline")){this._statusText=a;this.trigger("sendStatus",{to:this.options.info.id,show:a})}},_checkST:false,_typing:function(){var a=this;a.sendStatus("typing");
a._checkST&&clearTimeout(a._checkST);a._checkST=w.setTimeout(function(){a.sendStatus("clear")},6E3)},_setST:null,status:function(a){a=a||"clear";var b=this.$.status,d=this.options.info.nick,e="";e=a=="clear"?"":d+t(a);b.innerHTML=e;this._adjustContent();this._setST&&clearTimeout(this._setST);if(e!="")this._setST=w.setTimeout(function(){b.innerHTML=""},1E4)},destroy:function(){this.window.close()},ui:function(a){return f({self:this,$:this.$,history:this.history},a)},plugins:{}});x.chat.defaults.emot=
true;M.add("chat","emot",{init:function(a,b){var d=b.self,e=new x.emot;e.bind("select",function(j){d.focus();d.insert(j,true)});var h=H(G('<a href="#chat-emot" title="<%=emot%>"><em class="webim-icon webim-icon-emot"></em></a>'));s(h,"click",function(j){Q(j);e.toggle()});b.$.toolContent.appendChild(e.element);b.$.tools.appendChild(h)},send:function(){}});x.chat.defaults.clearHistory=true;M.add("chat","clearHistory",{init:function(a,b){var d=b.self,e=H(G('<a href="#chat-clearHistory" title="<%=clear history%>"><em class="webim-icon webim-icon-clear"></em></a>'));
s(e,"click",function(h){Q(h);d.trigger("clearHistory",[d.options.info])});b.$.tools.appendChild(e)}});x.chat.defaults.block=true;M.add("chat","block",{init:function(a,b){var d=b.self,e=d.options.info.blocked,h=d.options.info.nick,j=H('<a href="#chat-block" style="display:'+(e?"none":"")+'" title="'+t("block group",{name:h})+'"><em class="webim-icon webim-icon-unblock"></em></a>'),l=H('<a href="#chat-block" style="display:'+(e?"":"none")+'" title="'+t("unblock group",{name:h})+'"><em class="webim-icon webim-icon-block"></em></a>');
s(j,"click",function(m){Q(m);z(j);F(l);d.trigger("block",[d.options.info])});s(l,"click",function(m){Q(m);z(l);F(j);d.trigger("unblock",[d.options.info])});b.$.tools.appendChild(j);b.$.tools.appendChild(l)}});x.chat.defaults.member=true;f(x.chat.prototype,{addMember:function(a,b,d){var e=this,h=e.memberLi;if(!h[a]){var j=H('<li><a class="'+(d?"ui-state-disabled":"")+'" href="'+a+'">'+b+"</a></li>");s(j.firstChild,"click",function(l){Q(l);d||e.trigger("select",[{id:a,nick:b}])});h[a]=j;e.$.member.appendChild(j);
e.$.memberCount.innerHTML=parseInt(e.$.memberCount.innerHTML)+1}},removeMember:function(a){var b=this.memberLi[a];if(b){this.$.member.removeChild(b);delete this.memberLi[a];this.$.memberCount.innerHTML=parseInt(this.$.memberCount.innerHTML)-1}}});M.add("chat","member",{init:function(a,b){var d=b.$;b.self.memberLi={};var e=H(G('<div class="webim-member ui-widget-content ui-corner-left"><iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><h4><%=room member%>(<span id=":memberCount">0</span>)</h4><ul id=":ul"></ul></div>')),
h=fa(e);d.member=h.ul;d.memberCount=h.memberCount;d.content.parentNode.insertBefore(e,d.content)}});ea("setting",{init:function(a){var b=this.im.setting,d=this.layout,e=this.setting=new x.setting(null,a);d.addWidget(e,{title:t("setting"),icon:"setting",sticky:false,onlyIcon:true,isMinimize:true});b.bind("update",function(h,j){typeof j!="object"&&e.check_tag(h,j)});e.bind("change",function(h,j){b.set(h,j)})},stop:function(){}});K("setting",{template:'<div id="webim-setting" class="webim-setting">\t\t\t<ul id=":ul"><%=tags%></ul>\t\t   </div>',
tpl_check:'<li id=":<%=name%>"><input type="checkbox" <%=checked%> id="webim-setting-<%=name%>" name="<%=name%>"/><label for="webim-setting-<%=name%>"><%=label%></label></li>'},{_init:function(){},template:function(){var a=this,b=[],d=a.options.data;d&&i(d,function(e,h){b.push(a._check_tpl(e,h))});return G(a.options.template,{tags:b.join("")})},_initEvents:function(){var a=this,b=a.options.data,d=a.$;b&&i(b,function(e){d[e]&&a._check_event(d[e])})},_check_tpl:function(a,b){return G(this.options.tpl_check,
{label:t(a),name:a,checked:b?'checked="checked"':""})},_check_event:function(a){var b=this;s(a.firstChild,"click",function(){b._change(this.name,this.checked)})},check_tag:function(a,b){var d=this;if($(a))i(a,function(j,l){d.check_tag(j,l)});else{var e=d.$,h=e[a];if(!(b&&typeof b=="boolean"))if(h)h.firstChild.checked=b;else{h=e[a]=H(d._check_tpl(a,b));d._check_event(h);e.ul.appendChild(h)}}},_change:function(a,b){this.trigger("change",[a,b])},destroy:function(){}});K("user",{template:'<div>  \t\t<div id=":user" class="webim-user"> \t\t\t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" src="about:blank" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t\t\t\t<div class="webim-user-show"><h4><a  id=":userShowTrigger" href="#show"><strong id=":userNick"></strong><span id=":userShow"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></span><em class="ui-icon ui-icon-triangle-1-s"><%=show_status_list%></em></a></h4>\t\t\t\t\t<p id=":userShowList" class="ui-state-active ui-corner-all" style="display: none;">\t\t\t\t\t\t<a href="#available" class="webim-user-show-available"><em class="webim-icon webim-icon-available"><%=available%></em><%=available%></a>\t\t\t\t\t\t<a href="#dnd" class="webim-user-show-dnd"><em class="webim-icon webim-icon-dnd"><%=dnd%></em><%=dnd%></a>\t\t\t\t\t\t<a href="#away" class="webim-user-show-away"><em class="webim-icon webim-icon-away"><%=away%></em><%=away%></a>\t\t\t\t\t\t<a href="#invisible" class="webim-user-show-invisible"><em class="webim-icon webim-icon-invisible"><%=invisible%></em><%=invisible%></a>\t\t\t\t\t\t<a href="#unavailable" class="webim-user-show-unavailable"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></a>\t\t\t\t\t</p>\t\t\t\t</div> \t\t\t\t\t<span id=":userStatus" title="" class="webim-user-status">Hello</span> \t\t\t\t\t\t</div> \t\t\t\t\t\t\t</div>'},
{_init:function(){},_initEvents:function(){var a=this,b=a.$,d=b.userShowList;s(b.userShowTrigger,"click",function(e){d.style.display=="block"?z(d):F(d);Q(e)});i(ka(d.firstChild),function(e,h){s(h,"click",function(j){a._set(this.href.split("#")[1]);z(d);Q(j)})})},update:function(a){var b=a.show||"available",d=this.$;this.options.info=a;d.userStatus.innerHTML=a.status||t(b);d.userNick.innerHTML=a.nick||"";d.userPic.setAttribute("href",a.url);d.userPic.firstChild.setAttribute("defaultsrc",a.default_pic_url?
a.default_pic_url:"");setTimeout(function(){d.userPic.firstChild.setAttribute("src",a.pic_url)},100);this.show(b)},show:function(a){var b=t(a);this.$.userShow.innerHTML='<em class="webim-icon webim-icon-'+a+'">'+b+"</em>"+b},_set:function(a){var b=this.options.info;this.show(a);if(b){if(b.show!=a)if(a=="unavailable")this.trigger("offline",[]);else b.show=="unavailable"?this.trigger("online",[{show:a}]):this.trigger("presence",[{show:a,status:b.status}])}else a!="unavailable"&&this.trigger("online",
[{show:a}])},destroy:function(){}});ea("buddy",{init:function(a){var b=this,d=b.im,e=d.buddy,h=b.layout,j=b.buddy=new x.buddy(null,a);h.addWidget(j,{title:t("buddy"),icon:"buddy",sticky:d.setting.get("buddy_sticky"),className:"webim-buddy-window",isMinimize:!d.status.get("b"),titleVisibleLength:19});d.setting.bind("update",function(m,n){m=="buddy_sticky"&&j.window.option("sticky",n)});j.bind("select",function(m){b.addChat("buddy",m.id);b.layout.focusChat("buddy",m.id)}).bind("online",function(){d.online()});
j.window.bind("displayStateChange",function(m){if(m!="minimize"){e.option("loadDelay",false);d.status.set("b",1);e.loadDelay()}else{d.status.set("b",0);e.option("loadDelay",true)}});e.bind("online",function(m){j.add(m);j.notice("count",e.count({presence:"online"}))});e.bind("onlineDelay",function(){j.notice("count",e.count({presence:"online"}))});var l=function(m){return $(m)?m.id:m};e.bind("offline",function(m){j.remove(p(m,l));j.notice("count",e.count({presence:"online"}))});e.bind("update",function(m){j.update(m)});
j.offline();j.user.bind("online",function(m){d.online(m)}).bind("offline",function(){d.offline()}).bind("presence",function(m){d.sendPresence(m)})},ready:function(){this.buddy.online()},go:function(){var a=this.im,b=a.buddy,d=this.buddy;!d.window.isMinimize()&&b.loadDelay();d.notice("count",b.count({presence:"online"}));d.user.update(a.data.user)},stop:function(a){var b=this.buddy;b.offline();b.user.show("unavailable");a&&b.notice(a)}});K("buddy",{template:'<div id="webim-buddy" class="webim-buddy">\t\t<div id=":search" class="webim-buddy-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-buddy-content">\t\t\t\t<div id=":empty" class="webim-buddy-empty"><%=empty buddy%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',
tpl_group:'<li><h4 class="ui-state-default"><%=title%>(<%=count%>)</h4><ul></ul></li>',tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong><span><%=status%></span></a></li>'},{_init:function(){this.groups={};this.li={};this.li_group={};this._count=0;this.user=new x.user;this.header=this.user.element;
this.window&&this.window.subHeader(this.header)},_initEvents:function(){var a=this,b=a.$,d=b.search,e=b.searchInput,h=t("search buddy");s(d.firstChild,"click",function(){e.focus()});e.value=h;s(e,"focus",function(){D(d,"ui-state-active");if(this.value==h)this.value=""});s(e,"blur",function(){E(d,"ui-state-active");if(this.value=="")this.value=h});s(e,"keyup",function(){var j=this.value;i(a.li,function(l,m){j&&(m.text||m.innerHTML.replace(/<[^>]*>/g,"")).indexOf(j)==-1?z(m):F(m)})})},_titleCount:function(){var a=
this._count,b=this.window,d=this.$.empty;b&&b.title(t("buddy")+"("+(a?a:"0")+")");a?z(d):F(d);a>8?this.scroll(true):this.scroll(false)},scroll:function(a){ha(this.element,"webim-buddy-scroll",a)},_time:null,_titleBuddyOnline:function(a){var b=this;a||(a="");b._time&&clearTimeout(b._time);b._time=setTimeout(function(){b._titleCount()},5E3)},_title:function(a){var b=this.window;b&&b.title(t("buddy")+"["+t(a)+"]")},notice:function(a,b){switch(a){case "buddyOnline":this._titleBuddyOnline(b);break;case "count":this._count=
b;this._titleCount();break;default:this._title(a)}},online:function(){var a=this.$;this.notice("connect");F(a.empty)},offline:function(){var a=this.$;this.notice("offline");F(a.empty);this.scroll(false);this.removeAll()},_updateInfo:function(a,b){a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");a.setAttribute("src",b.pic_url);a=a.nextSibling;a.innerHTML=b.nick;a=a.nextSibling;a.innerHTML=b.status;return a},_addOne:function(a,
b){var d=this,e=d.li,h=a.id,j=d.$.ul;if(!e[h]){if(!a.default_pic_url)a.default_pic_url="";e=e[h]=H(G(d.options.tpl_li,a));s(e.firstChild,"click",function(n){Q(n);d.trigger("select",[a]);this.blur()});var l=d.groups,m=t(a.group||"friend");l=l[m];if(!l){l=H(G(d.options.tpl_group));z(l);if(m==t("stranger"))b=true;b?j.appendChild(l):j.insertBefore(l,j.firstChild);l={name:m,el:l,count:0,title:l.firstChild,li:l.lastChild};d.groups[m]=l}l.count==0&&F(l.el);d.li_group[h]=l;l.li.appendChild(e);l.count++;l.title.innerHTML=
m+"("+l.count+")"}},_updateOne:function(a){var b=this.li,d=a.id;b[d]&&this._updateInfo(b[d],a)},update:function(a){a=g(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a,b){a=g(a);for(var d=0;d<a.length;d++)this._addOne(a[d],b)},removeAll:function(){var a=[],b=this.li;for(var d in b)a.push(d);this.remove(a)},remove:function(a){var b,d,e=this.li,h,j=this.li_group;a=la(a);for(var l=0;l<a.length;l++){b=a[l];if(d=e[b]){if(h=j[b]){h.count--;h.count==0&&z(h.el);h.title.innerHTML=h.name+
"("+h.count+")"}C(d);delete e[b]}}},select:function(a){(a=this.li[a])&&a.firstChild.click();return a},destroy:function(){}});ea("room",{init:function(){function a(n){var u=n.nick;n=f({},n,{group:"group",nick:u+"("+(parseInt(n.count)+"/"+parseInt(n.all_count))+")"});l.updateChat(n);n.blocked&&(n.nick=u+"("+t("blocked")+")");m.li[n.id]?m.update(n):m.add(n)}var b=this,d=b.im,e=d.room,h=d.setting,j=d.data.user,l=b.layout,m=b.room=(new webim.ui.room(null)).bind("select",function(n){b.addChat("room",n.id);
b.layout.focusChat("room",n.id)});l.addWidget(m,{title:t("room"),icon:"room",sticky:d.setting.get("buddy_sticky"),onlyIcon:true,isMinimize:true},"notification");d.setting.bind("update",function(n,u){n=="buddy_sticky"&&m.window.option("sticky",u)});e.bind("join",function(n){a(n)}).bind("leave",function(){}).bind("block",function(n,u){h.set("blocked_rooms",u);a(e.get(n));e.leave(n,j)}).bind("unblock",function(n,u){h.set("blocked_rooms",u);a(e.get(n));e.join(n,j)}).bind("addMember",function(n,u){var I=
l.chat("room",n);I&&I.addMember(u.id,u.nick,u.id==d.data.user.id);a(e.get(n))}).bind("removeMember",function(n,u){var I=l.chat("room",n);I&&I.removeMember(u.id,u.nick);a(e.get(n))})},ready:function(){},go:function(){},stop:function(){}});K("room",{template:'<div id="webim-room" class="webim-room">\t\t<div id=":search" class="webim-room-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-room-content">\t\t\t\t<div id=":empty" class="webim-room-empty"><%=empty room%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',
tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong></a></li>'},{_init:function(){this.li={};this._count=0;F(this.$.empty)},_initEvents:function(){var a=this,b=a.$,d=b.search,e=b.searchInput,h=t("search room");s(d.firstChild,"click",function(){e.focus()});e.value=h;s(e,"focus",function(){D(d,
"ui-state-active");if(this.value==h)this.value=""});s(e,"blur",function(){E(d,"ui-state-active");if(this.value=="")this.value=h});s(e,"keyup",function(){var j=this.value;i(a.li,function(l,m){j&&(m.text||m.innerHTML.replace(/<[^>]*>/g,"")).indexOf(j)==-1?z(m):F(m)})})},scroll:function(a){ha(this.element,"webim-room-scroll",a)},_updateInfo:function(a,b){a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");a.setAttribute("src",
b.pic_url);a=a.nextSibling;a.innerHTML=b.nick;return a},_addOne:function(a){var b=this,d=b.li,e=a.id,h=b.$.ul;if(!d[e]){if(!a.default_pic_url)a.default_pic_url="";d=d[e]=H(G(b.options.tpl_li,a));s(d.firstChild,"click",function(j){Q(j);b.trigger("select",[a]);this.blur()});h.appendChild(d)}},_updateOne:function(a){var b=this.li,d=a.id;b[d]&&this._updateInfo(b[d],a)},update:function(a){a=g(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a){z(this.$.empty);a=g(a);for(var b=0;b<a.length;b++)this._addOne(a[b])},
removeAll:function(){var a=[],b=this.li;for(var d in b)a.push(d);this.remove(a)},remove:function(a){var b,d,e=this.li;a=la(a);for(var h=0;h<a.length;h++){b=a[h];if(d=e[b]){C(d);delete e[b]}}},select:function(a){(a=this.li[a])&&a.firstChild.click();return a},destroy:function(){}});ea("menu",{init:function(a){var b=this.layout;a=this.menu=new x.menu(null,a);b.addWidget(a,{title:t("menu"),icon:"home",sticky:false,onlyIcon:false,isMinimize:true},null,"shortcut")}});K("menu",{template:'<div id="webim-menu" class="webim-menu">\t\t<ul id=":ul"><%=list%></ul>\t\t\t<div id=":empty" class="webim-menu-empty"><%=empty menu%></div>\t\t\t\t</div>',
tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><img src="<%=icon%>"/><span><%=title%></span></a></li>'},{_init:function(){var a=this.options;a.data&&a.data.length&&z(this.$.empty)},template:function(){var a=this,b=[],d=a.options.data;d&&i(d,function(e,h){b.push(a._li_tpl(h))});return G(a.options.template,{list:b.join("")})},_li_tpl:function(a){return G(this.options.tpl_li,{title:t(a.title),icon:a.icon,link:a.link,target:a.isExtlink?"_blank":""})},_fitUI:function(){var a=this.element;if(a.clientHeight>
300)a.style.height="300px"},add:function(a){var b=this;if(P(a))i(a,function(e,h){b.add(h)});else{var d=b.$;z(d.empty);d.ul.appendChild(H(b._li_tpl(a)))}},destroy:function(){}});q("notification",{url:"webim/notifications"},{grep:function(a){return a&&a.text},handle:function(a){a=k(g(a),this.grep);a.length&&this.trigger("data",[a])},load:function(){o({url:this.options.url,cache:false,dataType:"json",context:this,success:this.handle})}});ea("notification",{init:function(a){var b=this.im,d=this.layout,
e=this.notification=new x.notification(null,a),h=b.notification=new webim.notification;d.addWidget(e,{title:t("notification"),icon:"notification",sticky:false,onlyIcon:true,isMinimize:true});h.bind("data",function(j){e.window.notifyUser("information","+"+j.length);e.add(j)});setTimeout(function(){h.load()},2E3)}});K("notification",{template:'<div id="webim-notification" class="webim-notification">\t\t<ul id=":ul"><%=list%></ul>\t\t\t<div id=":empty" class="webim-notification-empty"><%=empty notification%></div>\t\t\t\t</div>',
tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><%=text%></a></li>'},{_init:function(){var a=this.options;a.data&&a.data.length&&z(this.$.empty)},template:function(){var a=this,b=[],d=a.options.data;d&&i(d,function(e,h){b.push(a._li_tpl(h))});return G(a.options.template,{list:b.join("")})},_li_tpl:function(){return G(this.options.tpl_li,{text:text,link:link,target:isExtlink?"_blank":""})},_fitUI:function(){var a=this.element;if(a.clientHeight>300)a.style.height="300px"},add:function(a){var b=
this;if(P(a))i(a,function(e,h){b.add(h)});else{var d=b.$;z(d.empty);d.ul.appendChild(H(b._li_tpl(a)))}},destroy:function(){}})})(window,document);
